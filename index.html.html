<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Martinas Company Limited ‚Äî Enterprise Accounting System</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --primary: #1a3a2a;
    --primary-light: #2d5a3d;
    --accent: #c9a84c;
    --accent-light: #e8c97a;
    --bg: #f5f2eb;
    --bg-card: #ffffff;
    --bg-sidebar: #1a3a2a;
    --text: #1a1a1a;
    --text-muted: #6b7280;
    --text-light: #9ca3af;
    --border: #e5e0d5;
    --danger: #dc2626;
    --danger-light: #fef2f2;
    --success: #16a34a;
    --success-light: #f0fdf4;
    --warning: #d97706;
    --warning-light: #fffbeb;
    --info: #2563eb;
    --info-light: #eff6ff;
    --martinas: #1a3a2a;
    --tetteh: #7c3aed;
    --ecopower: #b45309;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== LOGIN ===== */
  #loginScreen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a3a2a 0%, #0d2018 50%, #1a3a2a 100%);
    position: relative;
    overflow: hidden;
  }
  #loginScreen::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at center, rgba(201,168,76,0.08) 0%, transparent 70%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
  
  .login-card {
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 20px;
    padding: 48px 40px;
    width: 420px;
    position: relative;
    z-index: 1;
    box-shadow: 0 32px 80px rgba(0,0,0,0.4);
  }
  .login-logo {
    text-align: center;
    margin-bottom: 32px;
  }
  .login-logo h1 {
    font-family: 'Playfair Display', serif;
    color: var(--accent);
    font-size: 22px;
    line-height: 1.3;
    margin-bottom: 4px;
  }
  .login-logo p { color: rgba(255,255,255,0.5); font-size: 12px; letter-spacing: 2px; text-transform: uppercase; }
  .login-divider { width: 60px; height: 2px; background: var(--accent); margin: 16px auto; border-radius: 2px; }
  
  .form-group { margin-bottom: 20px; }
  .form-group label { display: block; color: rgba(255,255,255,0.7); font-size: 12px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: var(--radius-sm);
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    transition: all 0.2s;
    outline: none;
  }
  .form-group input:focus { border-color: var(--accent); background: rgba(255,255,255,0.12); }
  .form-group input::placeholder { color: rgba(255,255,255,0.3); }
  
  .btn-primary {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: #1a1a1a;
    border: none;
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: 0 8px 20px rgba(201,168,76,0.3); }
  
  .login-error { color: #f87171; font-size: 13px; text-align: center; margin-top: 12px; display: none; }

  /* ===== MAIN APP ===== */
  #app { display: none; min-height: 100vh; }
  
  /* SIDEBAR */
  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 260px;
    background: var(--bg-sidebar);
    display: flex;
    flex-direction: column;
    z-index: 100;
    overflow-y: auto;
  }
  .sidebar-header {
    padding: 24px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .sidebar-header h2 {
    font-family: 'Playfair Display', serif;
    color: var(--accent);
    font-size: 14px;
    line-height: 1.4;
  }
  .sidebar-header p { color: rgba(255,255,255,0.4); font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; margin-top: 2px; }
  
  .sidebar-user {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .user-avatar {
    width: 36px; height: 36px;
    background: var(--accent);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px; color: #1a1a1a;
    flex-shrink: 0;
  }
  .user-info { flex: 1; min-width: 0; }
  .user-info strong { color: white; font-size: 13px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .user-info span { color: rgba(255,255,255,0.4); font-size: 11px; }
  
  .sidebar-nav { flex: 1; padding: 12px 0; }
  .nav-section { margin-bottom: 4px; }
  .nav-section-title { color: rgba(255,255,255,0.3); font-size: 10px; letter-spacing: 2px; text-transform: uppercase; padding: 8px 20px 4px; }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 20px;
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    transition: all 0.15s;
    font-size: 13px;
    font-weight: 500;
    border-left: 3px solid transparent;
  }
  .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
  .nav-item.active { color: var(--accent); background: rgba(201,168,76,0.1); border-left-color: var(--accent); }
  .nav-item .icon { width: 18px; text-align: center; font-size: 15px; }
  
  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  .btn-logout {
    width: 100%; padding: 10px; background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.3);
    color: #f87171; border-radius: var(--radius-sm); cursor: pointer; font-size: 13px; font-weight: 500;
    transition: all 0.2s;
  }
  .btn-logout:hover { background: rgba(220,38,38,0.25); }

  /* MAIN CONTENT */
  .main-content {
    margin-left: 260px;
    min-height: 100vh;
    padding: 24px;
  }
  
  .page-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px;
  }
  .page-header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    color: var(--text);
  }
  .page-header p { color: var(--text-muted); font-size: 14px; margin-top: 2px; }
  
  /* CARDS */
  .card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }
  .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  
  /* GRID */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
  .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; }
  
  /* STAT CARDS */
  .stat-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }
  .stat-card .label { color: var(--text-muted); font-size: 12px; font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase; }
  .stat-card .value { font-size: 28px; font-weight: 700; margin: 6px 0 4px; color: var(--text); font-family: 'DM Mono', monospace; }
  .stat-card .sub { font-size: 12px; color: var(--text-light); }
  .stat-card .trend-up { color: var(--success); }
  .stat-card .trend-down { color: var(--danger); }
  .stat-card.accent { border-top: 3px solid var(--accent); }
  .stat-card.green { border-top: 3px solid var(--success); }
  .stat-card.red { border-top: 3px solid var(--danger); }
  .stat-card.blue { border-top: 3px solid var(--info); }
  .stat-card.purple { border-top: 3px solid #7c3aed; }
  .stat-card.orange { border-top: 3px solid var(--warning); }
  
  /* ENTITY BADGES */
  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .badge-martinas { background: rgba(26,58,42,0.1); color: var(--martinas); }
  .badge-tetteh { background: rgba(124,58,237,0.1); color: var(--tetteh); }
  .badge-ecopower { background: rgba(180,83,9,0.1); color: var(--ecopower); }
  .badge-success { background: var(--success-light); color: var(--success); }
  .badge-danger { background: var(--danger-light); color: var(--danger); }
  .badge-warning { background: var(--warning-light); color: var(--warning); }
  .badge-info { background: var(--info-light); color: var(--info); }
  
  /* TABLES */
  .table-wrap { overflow-x: auto; border-radius: var(--radius-sm); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th {
    background: #f9f8f5;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 11px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    padding: 10px 14px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }
  td { padding: 11px 14px; border-bottom: 1px solid #f0ede8; color: var(--text); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #faf9f7; }
  .mono { font-family: 'DM Mono', monospace; font-size: 13px; }
  
  /* BUTTONS */
  .btn { padding: 8px 16px; border-radius: var(--radius-sm); border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-green { background: var(--success); color: white; }
  .btn-green:hover { background: #15803d; }
  .btn-red { background: var(--danger); color: white; }
  .btn-red:hover { background: #b91c1c; }
  .btn-accent { background: var(--accent); color: #1a1a1a; font-weight: 600; }
  .btn-accent:hover { background: var(--accent-light); }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
  .btn-outline:hover { background: var(--bg); border-color: #ccc; }
  .btn-icon { padding: 6px 10px; }
  
  /* FORMS */
  .form-row { display: grid; gap: 16px; margin-bottom: 16px; }
  .form-row.cols-2 { grid-template-columns: 1fr 1fr; }
  .form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  .form-row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
  
  .field label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
  .field input, .field select, .field textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--text);
    background: white;
    transition: border-color 0.2s;
    outline: none;
  }
  .field input:focus, .field select:focus, .field textarea:focus { border-color: var(--accent); }
  .field textarea { resize: vertical; min-height: 80px; }
  
  /* TABS */
  .tab-bar { display: flex; gap: 4px; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
  .tab-btn { padding: 10px 18px; border: none; background: transparent; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; color: var(--text-muted); border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
  .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
  .tab-btn:hover:not(.active) { color: var(--text); }
  
  /* ENTITY TABS */
  .entity-tab-bar { display: flex; gap: 8px; margin-bottom: 20px; }
  .entity-tab {
    padding: 8px 18px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;
    border: 1.5px solid transparent; transition: all 0.2s;
  }
  .entity-tab.martinas { border-color: var(--martinas); color: var(--martinas); }
  .entity-tab.martinas.active { background: var(--martinas); color: white; }
  .entity-tab.tetteh { border-color: var(--tetteh); color: var(--tetteh); }
  .entity-tab.tetteh.active { background: var(--tetteh); color: white; }
  .entity-tab.ecopower { border-color: var(--ecopower); color: var(--ecopower); }
  .entity-tab.ecopower.active { background: var(--ecopower); color: white; }
  .entity-tab.all { border-color: #6b7280; color: #6b7280; }
  .entity-tab.all.active { background: #6b7280; color: white; }
  
  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; padding: 20px; display: none;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: white; border-radius: 16px; box-shadow: var(--shadow-lg);
    width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;
  }
  .modal-lg { max-width: 800px; }
  .modal-xl { max-width: 1000px; }
  .modal-header {
    padding: 20px 24px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; background: white; z-index: 1;
  }
  .modal-header h3 { font-family: 'Playfair Display', serif; font-size: 18px; }
  .modal-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted); padding: 4px; }
  .modal-body { padding: 24px; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
  
  /* ALERTS */
  .alert { padding: 12px 16px; border-radius: var(--radius-sm); font-size: 13px; margin-bottom: 16px; }
  .alert-success { background: var(--success-light); color: var(--success); border-left: 3px solid var(--success); }
  .alert-danger { background: var(--danger-light); color: var(--danger); border-left: 3px solid var(--danger); }
  .alert-warning { background: var(--warning-light); color: var(--warning); border-left: 3px solid var(--warning); }
  .alert-info { background: var(--info-light); color: var(--info); border-left: 3px solid var(--info); }
  
  /* SEARCH/FILTER BAR */
  .filter-bar { display: flex; gap: 10px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
  .search-input {
    flex: 1; min-width: 200px; padding: 9px 14px;
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    font-size: 13px; outline: none; transition: border-color 0.2s;
  }
  .search-input:focus { border-color: var(--accent); }
  
  /* SECTION PAGES */
  .section-page { display: none; }
  .section-page.active { display: block; }
  
  /* RECEIPT UPLOAD */
  .upload-area {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #faf9f7;
  }
  .upload-area:hover { border-color: var(--accent); background: #faf8f2; }
  .upload-area p { color: var(--text-muted); font-size: 14px; margin-top: 8px; }
  .upload-icon { font-size: 36px; }
  
  /* REPORT PRINT */
  .report-header { text-align: center; padding-bottom: 20px; border-bottom: 2px solid var(--border); margin-bottom: 24px; }
  .report-header h2 { font-family: 'Playfair Display', serif; font-size: 22px; }
  .report-header p { color: var(--text-muted); font-size: 13px; }
  
  .report-section { margin-bottom: 24px; }
  .report-section h3 { font-family: 'Playfair Display', serif; font-size: 16px; margin-bottom: 12px; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 6px; }
  
  /* MISC */
  .text-right { text-align: right; }
  .text-center { text-align: center; }
  .fw-bold { font-weight: 700; }
  .text-success { color: var(--success); }
  .text-danger { color: var(--danger); }
  .text-warning { color: var(--warning); }
  .text-muted { color: var(--text-muted); }
  .mt-16 { margin-top: 16px; }
  .mt-24 { margin-top: 24px; }
  .mb-16 { margin-bottom: 16px; }
  .flex { display: flex; }
  .flex-between { display: flex; justify-content: space-between; align-items: center; }
  .flex-gap { gap: 10px; }
  .hidden { display: none !important; }
  
  /* RECEIPT PREVIEW */
  .receipt-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; }
  
  /* PETTY CASH */
  .petty-balance {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
  }
  .petty-balance .amount { font-size: 36px; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--accent); }
  
  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #d1cbc0; border-radius: 3px; }
  
  @media print {
    .sidebar, .btn, .filter-bar, .tab-bar, .entity-tab-bar { display: none !important; }
    .main-content { margin-left: 0 !important; }
    .card { box-shadow: none; border: 1px solid #ccc; }
  }

  /* DASHBOARD CHART PLACEHOLDER */
  .chart-bar-container { display: flex; align-items: flex-end; gap: 8px; height: 120px; padding: 10px 0; }
  .chart-bar { flex: 1; border-radius: 4px 4px 0 0; min-width: 20px; transition: all 0.3s; position: relative; }
  .chart-bar:hover { opacity: 0.8; }
  .chart-bar .bar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--text-muted); white-space: nowrap; }
  .chart-bar .bar-val { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: 600; white-space: nowrap; }
  
  /* ACTIVITY LOG */
  .activity-item { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f0ede8; font-size: 13px; }
  .activity-item:last-child { border-bottom: none; }
  .activity-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }

  /* FIRST LOGIN SETUP */
  #setupScreen {
    min-height: 100vh;
    display: none;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a3a2a 0%, #0d2018 100%);
  }
  .setup-card {
    background: white;
    border-radius: 20px;
    padding: 48px 40px;
    width: 500px;
    box-shadow: 0 32px 80px rgba(0,0,0,0.4);
  }
  .setup-card h2 { font-family: 'Playfair Display', serif; font-size: 24px; margin-bottom: 6px; }
  .setup-card p { color: var(--text-muted); font-size: 14px; margin-bottom: 28px; }
  .setup-field { margin-bottom: 16px; }
  .setup-field label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
  .setup-field input { width: 100%; padding: 11px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 14px; outline: none; transition: border-color 0.2s; }
  .setup-field input:focus { border-color: var(--accent); }
  .setup-btn { width: 100%; padding: 13px; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 8px; }
  .setup-btn:hover { background: var(--primary-light); }
</style>
</head>
<body>

<!-- FIRST SETUP SCREEN -->
<div id="setupScreen" style="display:none; min-height:100vh; align-items:center; justify-content:center; background:linear-gradient(135deg,#1a3a2a,#0d2018);">
  <div class="setup-card">
    <h2>üè¢ Welcome to Martinas EAS</h2>
    <p>You're setting up the system for the first time. Create your owner/admin account below.</p>
    <div class="setup-field"><label>Full Name</label><input type="text" id="setupName" placeholder="Your full name"></div>
    <div class="setup-field"><label>Email Address</label><input type="email" id="setupEmail" placeholder="owner@martinascompany.com"></div>
    <div class="setup-field"><label>Password</label><input type="password" id="setupPass" placeholder="Strong password"></div>
    <div class="setup-field"><label>Confirm Password</label><input type="password" id="setupPass2" placeholder="Repeat password"></div>
    <div id="setupError" class="login-error"></div>
    <button class="setup-btn" onclick="completeSetup()">Create Admin Account & Launch System</button>
  </div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="display:none;">
  <div class="login-card">
    <div class="login-logo">
      <h1>MARTINAS COMPANY LIMITED</h1>
      <div class="login-divider"></div>
      <p>Enterprise Accounting System</p>
    </div>
    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="loginEmail" placeholder="Enter your email">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Enter your password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn-primary" onclick="doLogin()">Sign In</button>
    <p class="login-error" id="loginError">Invalid email or password</p>
    <p style="color:rgba(255,255,255,0.3);font-size:11px;text-align:center;margin-top:20px;">Martinas Company Limited ¬© 2024</p>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>MARTINAS COMPANY<br>LIMITED</h2>
      <p>Enterprise Accounting System</p>
    </div>
    <div class="sidebar-user">
      <div class="user-avatar" id="sidebarAvatar">A</div>
      <div class="user-info">
        <strong id="sidebarName">Admin</strong>
        <span id="sidebarRole">Owner</span>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <div class="nav-item active" onclick="showSection('dashboard')"><span class="icon">üìä</span> Dashboard</div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Finance</div>
        <div class="nav-item" onclick="showSection('income')"><span class="icon">üí∞</span> Income</div>
        <div class="nav-item" onclick="showSection('expenditure')"><span class="icon">üí≥</span> Expenditure</div>
        <div class="nav-item" onclick="showSection('petty')"><span class="icon">üè¶</span> Petty Cash</div>
        <div class="nav-item" onclick="showSection('assets')"><span class="icon">üèõÔ∏è</span> Assets & Liabilities</div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Departments</div>
        <div class="nav-item" onclick="showSection('payroll')"><span class="icon">üë•</span> Payroll</div>
        <div class="nav-item" onclick="showSection('ecopower')"><span class="icon">‚õΩ</span> Eco-Power Sales</div>
        <div class="nav-item" onclick="showSection('cleaning')"><span class="icon">üßπ</span> Tetteh Osei Cleaning</div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Documents</div>
        <div class="nav-item" onclick="showSection('receipts')"><span class="icon">üìÑ</span> Receipts & Invoices</div>
        <div class="nav-item" onclick="showSection('reports')"><span class="icon">üìà</span> Financial Reports</div>
      </div>
      <div class="nav-section nav-admin" id="adminNav">
        <div class="nav-section-title">Administration</div>
        <div class="nav-item" onclick="showSection('users')"><span class="icon">üîê</span> User Management</div>
        <div class="nav-item" onclick="showSection('audit')"><span class="icon">üóíÔ∏è</span> Audit Log</div>
        <div class="nav-item" onclick="showSection('backup')"><span class="icon">üíæ</span> Backup & Export</div>
      </div>
    </nav>
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="doLogout()">‚èª Sign Out</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">

    <!-- DASHBOARD -->
    <div id="sec-dashboard" class="section-page active">
      <div class="page-header">
        <div><h1>Dashboard</h1><p id="dashDate"></p></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-outline btn-sm" onclick="refreshDashboard()">üîÑ Refresh</button>
          <button class="btn btn-accent btn-sm" onclick="showSection('reports')">üìà Reports</button>
        </div>
      </div>
      <!-- ENTITY STATS -->
      <div style="margin-bottom:20px;">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
          <span style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">Entity Overview</span>
        </div>
        <div class="grid-3" id="entityStats"></div>
      </div>
      <div class="grid-4 mb-16" id="summaryStats"></div>
      <div class="grid-2 mt-16">
        <div class="card">
          <div class="card-title">üí∞ Revenue by Entity (This Month)</div>
          <div id="revenueChart" class="chart-bar-container"></div>
          <div style="display:flex;gap:16px;margin-top:32px;font-size:12px;">
            <span><span style="display:inline-block;width:10px;height:10px;background:var(--martinas);border-radius:2px;margin-right:4px;"></span>Martinas</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:var(--tetteh);border-radius:2px;margin-right:4px;"></span>Tetteh Osei</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:var(--ecopower);border-radius:2px;margin-right:4px;"></span>Eco-Power</span>
          </div>
        </div>
        <div class="card">
          <div class="card-title">üïê Recent Activity</div>
          <div id="recentActivity"></div>
        </div>
      </div>
      <div class="grid-3 mt-16">
        <div class="card">
          <div class="card-title">‚õΩ Eco-Power Stock</div>
          <div id="dashEcoStock"></div>
        </div>
        <div class="card">
          <div class="card-title">üßπ Cleaner Summary</div>
          <div id="dashCleaners"></div>
        </div>
        <div class="card">
          <div class="card-title">üíµ Petty Cash</div>
          <div id="dashPettyCash"></div>
        </div>
      </div>
    </div>

    <!-- INCOME -->
    <div id="sec-income" class="section-page">
      <div class="page-header">
        <div><h1>Income Records</h1><p>Track all revenue across entities</p></div>
        <button class="btn btn-accent" onclick="openModal('incomeModal')">+ Record Income</button>
      </div>
      <div class="entity-tab-bar">
        <div class="entity-tab all active" onclick="filterIncomeEntity('all',this)">All Entities</div>
        <div class="entity-tab martinas" onclick="filterIncomeEntity('martinas',this)">Martinas</div>
        <div class="entity-tab tetteh" onclick="filterIncomeEntity('tetteh',this)">Tetteh Osei</div>
        <div class="entity-tab ecopower" onclick="filterIncomeEntity('ecopower',this)">Eco-Power</div>
      </div>
      <div class="card">
        <div class="filter-bar">
          <input class="search-input" type="text" id="incomeSearch" placeholder="Search income records..." oninput="renderIncome()">
          <select class="search-input" style="flex:0;width:auto;" id="incomeMonthFilter" onchange="renderIncome()">
            <option value="">All Months</option>
          </select>
          <button class="btn btn-outline btn-sm" onclick="printSection('income')">üñ® Print</button>
        </div>
        <div class="grid-3 mb-16" id="incomeSummary"></div>
        <div class="table-wrap">
          <table id="incomeTable">
            <thead><tr><th>Date</th><th>Entity</th><th>Category</th><th>Description</th><th>Reference</th><th>Receipt</th><th class="text-right">Amount (GHS)</th><th>Action</th></tr></thead>
            <tbody id="incomeBody"></tbody>
          </table>
        </div>
        <div id="incomeTotalRow" style="text-align:right;padding:12px 0;font-weight:700;font-family:'DM Mono',monospace;font-size:15px;border-top:2px solid var(--border);margin-top:8px;"></div>
      </div>
    </div>

    <!-- EXPENDITURE -->
    <div id="sec-expenditure" class="section-page">
      <div class="page-header">
        <div><h1>Expenditure Records</h1><p>Track all expenses across entities</p></div>
        <button class="btn btn-accent" onclick="openModal('expModal')">+ Record Expense</button>
      </div>
      <div class="entity-tab-bar">
        <div class="entity-tab all active" onclick="filterExpEntity('all',this)">All Entities</div>
        <div class="entity-tab martinas" onclick="filterExpEntity('martinas',this)">Martinas</div>
        <div class="entity-tab tetteh" onclick="filterExpEntity('tetteh',this)">Tetteh Osei</div>
        <div class="entity-tab ecopower" onclick="filterExpEntity('ecopower',this)">Eco-Power</div>
      </div>
      <div class="card">
        <div class="filter-bar">
          <input class="search-input" type="text" id="expSearch" placeholder="Search expenses..." oninput="renderExp()">
          <select class="search-input" style="flex:0;width:auto;" id="expMonthFilter" onchange="renderExp()">
            <option value="">All Months</option>
          </select>
          <button class="btn btn-outline btn-sm" onclick="printSection('expenditure')">üñ® Print</button>
        </div>
        <div class="grid-3 mb-16" id="expSummary"></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Date</th><th>Entity</th><th>Category</th><th>Description</th><th>Vendor</th><th>Receipt</th><th class="text-right">Amount (GHS)</th><th>Action</th></tr></thead>
            <tbody id="expBody"></tbody>
          </table>
        </div>
        <div id="expTotalRow" style="text-align:right;padding:12px 0;font-weight:700;font-family:'DM Mono',monospace;font-size:15px;border-top:2px solid var(--border);margin-top:8px;"></div>
      </div>
    </div>

    <!-- PETTY CASH -->
    <div id="sec-petty" class="section-page">
      <div class="page-header">
        <div><h1>Petty Cash</h1><p>Manage petty cash transactions per entity</p></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-outline" onclick="openModal('fundPettyModal')">üíµ Fund Float</button>
          <button class="btn btn-accent" onclick="openModal('pettyModal')">+ Petty Cash Entry</button>
        </div>
      </div>
      <div class="entity-tab-bar">
        <div class="entity-tab martinas active" onclick="filterPettyEntity('martinas',this)">Martinas</div>
        <div class="entity-tab tetteh" onclick="filterPettyEntity('tetteh',this)">Tetteh Osei</div>
        <div class="entity-tab ecopower" onclick="filterPettyEntity('ecopower',this)">Eco-Power</div>
      </div>
      <div class="petty-balance">
        <div style="font-size:13px;opacity:0.7;margin-bottom:4px;">Current Float Balance</div>
        <div class="amount" id="pettyBalance">GHS 0.00</div>
        <div style="font-size:12px;opacity:0.6;margin-top:4px;" id="pettyEntity">Martinas Company Limited</div>
      </div>
      <div class="card">
        <div class="filter-bar">
          <input class="search-input" type="text" id="pettySearch" placeholder="Search petty cash..." oninput="renderPetty()">
          <button class="btn btn-outline btn-sm" onclick="printSection('petty')">üñ® Print</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Authorized By</th><th>Receipt</th><th class="text-right">Amount (GHS)</th><th class="text-right">Balance</th><th>Action</th></tr></thead>
            <tbody id="pettyBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ASSETS & LIABILITIES -->
    <div id="sec-assets" class="section-page">
      <div class="page-header">
        <div><h1>Assets & Liabilities</h1><p>Fixed assets, depreciation, and liabilities</p></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-outline" onclick="openModal('liabilityModal')">+ Add Liability</button>
          <button class="btn btn-accent" onclick="openModal('assetModal')">+ Add Asset</button>
        </div>
      </div>
      <div class="entity-tab-bar">
        <div class="entity-tab all active" onclick="filterAssetsEntity('all',this)">All Entities</div>
        <div class="entity-tab martinas" onclick="filterAssetsEntity('martinas',this)">Martinas</div>
        <div class="entity-tab tetteh" onclick="filterAssetsEntity('tetteh',this)">Tetteh Osei</div>
        <div class="entity-tab ecopower" onclick="filterAssetsEntity('ecopower',this)">Eco-Power</div>
      </div>
      <div class="grid-4 mb-16" id="assetStats"></div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">üèõÔ∏è Fixed Assets</div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Asset</th><th>Entity</th><th>Purchase Date</th><th>Cost</th><th>Depreciation/yr</th><th>Net Value</th><th>Action</th></tr></thead>
              <tbody id="assetsBody"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-title">‚ö†Ô∏è Liabilities</div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Description</th><th>Entity</th><th>Due Date</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead>
              <tbody id="liabilitiesBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- PAYROLL -->
    <div id="sec-payroll" class="section-page">
      <div class="page-header">
        <div><h1>Payroll Management</h1><p>Manage staff payroll across all entities</p></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-outline" onclick="generatePayslips()">üìÑ Generate Payslips</button>
          <button class="btn btn-accent" onclick="openModal('staffModal')">+ Add Staff</button>
        </div>
      </div>
      <div class="entity-tab-bar">
        <div class="entity-tab all active" onclick="filterPayrollEntity('all',this)">All Staff</div>
        <div class="entity-tab martinas" onclick="filterPayrollEntity('martinas',this)">Martinas</div>
        <div class="entity-tab tetteh" onclick="filterPayrollEntity('tetteh',this)">Tetteh Osei</div>
        <div class="entity-tab ecopower" onclick="filterPayrollEntity('ecopower',this)">Eco-Power</div>
      </div>
      <div class="grid-4 mb-16" id="payrollStats"></div>
      <div class="card">
        <div class="filter-bar">
          <input class="search-input" type="text" id="payrollSearch" placeholder="Search staff..." oninput="renderPayroll()">
          <select class="search-input" style="flex:0;width:auto;" id="payrollStatusFilter" onchange="renderPayroll()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
          <button class="btn btn-outline btn-sm" onclick="printSection('payroll')">üñ® Print</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Name</th><th>Entity</th><th>Branch</th><th>Contact</th>
                <th>Bank</th><th>Account No.</th><th class="text-right">Salary (GHS)</th>
                <th>Status</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="payrollBody"></tbody>
          </table>
        </div>
        <div id="payrollTotalRow" style="text-align:right;padding:12px 0;font-weight:700;font-family:'DM Mono',monospace;font-size:15px;border-top:2px solid var(--border);margin-top:8px;"></div>
      </div>
    </div>

    <!-- ECO-POWER -->
    <div id="sec-ecopower" class="section-page">
      <div class="page-header">
        <div><h1>Eco-Power Sales</h1><p>Stock management and sales tracking</p></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-outline" onclick="openModal('ecoStockModal')">üì¶ Add Stock</button>
          <button class="btn btn-accent" onclick="openModal('ecoSaleModal')">+ Record Sale</button>
        </div>
      </div>
      <div class="grid-4 mb-16" id="ecoStats"></div>
      <div class="grid-2 mb-16">
        <div class="card">
          <div class="card-title">üì¶ Product Inventory</div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Product</th><th>Unit</th><th>Stock Qty</th><th>Retail Price</th><th>Wholesale Price</th><th>Dealer Price</th><th>Reorder Level</th><th>Status</th></tr></thead>
              <tbody id="ecoInventory"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-title">üë§ Debtors (Credit Sales)</div>
          <div id="ecoDebtors"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">üí≥ Sales Transactions</div>
        <div class="filter-bar">
          <input class="search-input" type="text" id="ecoSearch" placeholder="Search sales..." oninput="renderEcoSales()">
          <select class="search-input" style="flex:0;width:auto;" id="ecoPayFilter" onchange="renderEcoSales()">
            <option value="">All Payment Types</option>
            <option value="cash">Cash</option>
            <option value="credit">Credit</option>
          </select>
          <select class="search-input" style="flex:0;width:auto;" id="ecoMonthFilter" onchange="renderEcoSales()">
            <option value="">All Months</option>
          </select>
          <button class="btn btn-outline btn-sm" onclick="printSection('ecopower')">üñ® Print</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Date</th><th>Customer</th><th>Type</th><th>Product</th><th>Qty</th><th>Unit Price</th><th>Payment</th><th>Amount Paid</th><th class="text-right">Total (GHS)</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="ecoSalesBody"></tbody>
          </table>
        </div>
        <div id="ecoTotalRow" style="text-align:right;padding:12px 0;font-weight:700;font-family:'DM Mono',monospace;font-size:15px;border-top:2px solid var(--border);margin-top:8px;"></div>
      </div>
    </div>

    <!-- TETTEH OSEI CLEANING -->
    <div id="sec-cleaning" class="section-page">
      <div class="page-header">
        <div><h1>Tetteh Osei Cleaning Services</h1><p>Manage cleaner deployments and assignments</p></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-outline" onclick="openModal('contractModal')">üìã Add Contract</button>
          <button class="btn btn-accent" onclick="openModal('cleanerModal')">+ Add Cleaner</button>
        </div>
      </div>
      <div class="grid-4 mb-16" id="cleanerStats"></div>
      <div class="grid-2 mb-16">
        <div class="card">
          <div class="card-title">üßπ Cleaners</div>
          <div class="filter-bar">
            <input class="search-input" type="text" id="cleanerSearch" placeholder="Search cleaners..." oninput="renderCleaners()">
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Name</th><th>Establishment</th><th>Contact</th><th>Start Date</th><th>Monthly Pay</th><th>Status</th><th>Action</th></tr></thead>
              <tbody id="cleanersBody"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-title">üè¢ Client Contracts</div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Client</th><th>Location</th><th>Cleaners</th><th>Monthly Value</th><th>Status</th><th>Action</th></tr></thead>
              <tbody id="contractsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- RECEIPTS & INVOICES -->
    <div id="sec-receipts" class="section-page">
      <div class="page-header">
        <div><h1>Receipts & Invoices</h1><p>Scan, upload and manage documents</p></div>
        <button class="btn btn-accent" onclick="openModal('uploadModal')">+ Upload Document</button>
      </div>
      <div class="entity-tab-bar">
        <div class="entity-tab all active" onclick="filterDocsEntity('all',this)">All</div>
        <div class="entity-tab martinas" onclick="filterDocsEntity('martinas',this)">Martinas</div>
        <div class="entity-tab tetteh" onclick="filterDocsEntity('tetteh',this)">Tetteh Osei</div>
        <div class="entity-tab ecopower" onclick="filterDocsEntity('ecopower',this)">Eco-Power</div>
      </div>
      <div class="card">
        <div class="filter-bar">
          <input class="search-input" type="text" id="docsSearch" placeholder="Search documents..." oninput="renderDocs()">
          <select class="search-input" style="flex:0;width:auto;" id="docsTypeFilter" onchange="renderDocs()">
            <option value="">All Types</option>
            <option value="receipt">Receipt</option>
            <option value="invoice">Invoice</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div id="docsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;"></div>
      </div>
    </div>

    <!-- REPORTS -->
    <div id="sec-reports" class="section-page">
      <div class="page-header">
        <div><h1>Financial Reports</h1><p>Generate and view periodic financial statements</p></div>
        <button class="btn btn-accent" onclick="window.print()">üñ® Print Report</button>
      </div>
      <div class="grid-2 mb-16">
        <div class="card">
          <div class="card-title">‚öôÔ∏è Report Settings</div>
          <div class="form-row cols-2">
            <div class="field"><label>Entity</label>
              <select id="reportEntity">
                <option value="all">All Entities (Consolidated)</option>
                <option value="martinas">Martinas Company Limited</option>
                <option value="tetteh">Tetteh Osei Cleaning Services</option>
                <option value="ecopower">Eco-Power</option>
              </select>
            </div>
            <div class="field"><label>Report Type</label>
              <select id="reportType">
                <option value="income_statement">Income Statement (P&L)</option>
                <option value="cashflow">Cash Flow Statement</option>
                <option value="balance_sheet">Statement of Financial Position</option>
                <option value="expense_report">Expense Report</option>
                <option value="payroll_summary">Payroll Summary</option>
                <option value="ecopower_report">Eco-Power Sales Report</option>
                <option value="trial_balance">Trial Balance</option>
              </select>
            </div>
          </div>
          <div class="form-row cols-2">
            <div class="field"><label>From Date</label><input type="date" id="reportFrom"></div>
            <div class="field"><label>To Date</label><input type="date" id="reportTo"></div>
          </div>
          <button class="btn btn-accent" onclick="generateReport()" style="width:100%;">Generate Report</button>
        </div>
        <div class="card">
          <div class="card-title">üìã Quick Reports</div>
          <div style="display:grid;gap:10px;">
            <button class="btn btn-outline" onclick="quickReport('income_statement','all')">üìä Consolidated Income Statement</button>
            <button class="btn btn-outline" onclick="quickReport('balance_sheet','all')">üèõÔ∏è Statement of Financial Position</button>
            <button class="btn btn-outline" onclick="quickReport('cashflow','all')">üíß Cash Flow Statement</button>
            <button class="btn btn-outline" onclick="quickReport('payroll_summary','all')">üë• Full Payroll Summary</button>
            <button class="btn btn-outline" onclick="quickReport('ecopower_report','ecopower')">‚õΩ Eco-Power Full Report</button>
            <button class="btn btn-outline" onclick="quickReport('expense_report','all')">üí≥ Full Expense Report</button>
          </div>
        </div>
      </div>
      <div id="reportOutput"></div>
    </div>

    <!-- USER MANAGEMENT -->
    <div id="sec-users" class="section-page">
      <div class="page-header">
        <div><h1>User Management</h1><p>Control access and permissions</p></div>
        <button class="btn btn-accent" onclick="openModal('userModal')">+ Add User</button>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Access Level</th><th>Entities</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="usersBody"></tbody>
          </table>
        </div>
      </div>
      <div class="card mt-16">
        <div class="card-title">üîê Access Level Guide</div>
        <div class="grid-3">
          <div style="padding:16px;background:#f9f8f5;border-radius:8px;">
            <strong style="color:var(--danger);">üëë Owner/Admin</strong>
            <p style="font-size:12px;margin-top:6px;color:var(--text-muted);">Full access to all features, user management, reports, and system settings.</p>
          </div>
          <div style="padding:16px;background:#f9f8f5;border-radius:8px;">
            <strong style="color:var(--info);">üëî Manager</strong>
            <p style="font-size:12px;margin-top:6px;color:var(--text-muted);">Can view/add transactions, manage payroll and reports for assigned entities only.</p>
          </div>
          <div style="padding:16px;background:#f9f8f5;border-radius:8px;">
            <strong style="color:var(--success);">üìù Clerk</strong>
            <p style="font-size:12px;margin-top:6px;color:var(--text-muted);">Can record income, expenditure and petty cash. No access to payroll or admin settings.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- AUDIT LOG -->
    <div id="sec-audit" class="section-page">
      <div class="page-header">
        <div><h1>Audit Log</h1><p>Complete record of all system activity</p></div>
        <button class="btn btn-outline" onclick="printSection('audit')">üñ® Print Log</button>
      </div>
      <div class="card">
        <div class="filter-bar">
          <input class="search-input" type="text" id="auditSearch" placeholder="Search audit log..." oninput="renderAudit()">
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Date & Time</th><th>User</th><th>Action</th><th>Entity</th><th>Details</th></tr></thead>
            <tbody id="auditBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- BACKUP & EXPORT -->
    <div id="sec-backup" class="section-page">
      <div class="page-header">
        <div><h1>Backup & Export</h1><p>Protect your data ‚Äî export to Excel or create full backups</p></div>
      </div>

      <!-- DATA SUMMARY -->
      <div class="grid-4 mb-16" id="backupStats"></div>

      <!-- EXCEL EXPORT -->
      <div class="card mb-16">
        <div class="card-title">üìä Export to Excel (.xlsx)</div>
        <p style="color:var(--text-muted);font-size:14px;margin-bottom:20px;">
          Export your data to a professional Excel workbook with separate sheets for each data type. Perfect for sharing with your accountant or for further analysis.
        </p>
        <div class="grid-3" style="margin-bottom:20px;">
          <div style="background:#f9f8f5;border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
            <div style="font-size:24px;margin-bottom:8px;">üìë</div>
            <strong style="font-size:14px;">Full Workbook</strong>
            <p style="font-size:12px;color:var(--text-muted);margin-top:4px;">All data in one Excel file ‚Äî Income, Expenses, Payroll, Eco-Power, Cleaners, Assets, Liabilities, Petty Cash</p>
            <button class="btn btn-accent" style="margin-top:12px;width:100%;" onclick="exportExcel('all')">‚¨á Export All Data</button>
          </div>
          <div style="background:#f9f8f5;border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
            <div style="font-size:24px;margin-bottom:8px;">üí∞</div>
            <strong style="font-size:14px;">Finance Only</strong>
            <p style="font-size:12px;color:var(--text-muted);margin-top:4px;">Income, Expenditure, and Petty Cash sheets for your accountant or auditor</p>
            <button class="btn btn-green" style="margin-top:12px;width:100%;" onclick="exportExcel('finance')">‚¨á Export Finance</button>
          </div>
          <div style="background:#f9f8f5;border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
            <div style="font-size:24px;margin-bottom:8px;">üë•</div>
            <strong style="font-size:14px;">Payroll Only</strong>
            <p style="font-size:12px;color:var(--text-muted);margin-top:4px;">All staff and cleaners payroll data ‚Äî useful for bank payment processing</p>
            <button class="btn btn-outline" style="margin-top:12px;width:100%;border-color:var(--tetteh);color:var(--tetteh);" onclick="exportExcel('payroll')">‚¨á Export Payroll</button>
          </div>
        </div>
        <div class="grid-3">
          <div style="background:#f9f8f5;border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
            <div style="font-size:24px;margin-bottom:8px;">‚õΩ</div>
            <strong style="font-size:14px;">Eco-Power Only</strong>
            <p style="font-size:12px;color:var(--text-muted);margin-top:4px;">Sales transactions, inventory, and debtor listing for Eco-Power department</p>
            <button class="btn btn-outline" style="margin-top:12px;width:100%;border-color:var(--ecopower);color:var(--ecopower);" onclick="exportExcel('ecopower')">‚¨á Export Eco-Power</button>
          </div>
          <div style="background:#f9f8f5;border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
            <div style="font-size:24px;margin-bottom:8px;">üèõÔ∏è</div>
            <strong style="font-size:14px;">Assets & Liabilities</strong>
            <p style="font-size:12px;color:var(--text-muted);margin-top:4px;">Fixed asset register with depreciation schedule and full liabilities listing</p>
            <button class="btn btn-outline" style="margin-top:12px;width:100%;" onclick="exportExcel('assets')">‚¨á Export Assets</button>
          </div>
          <div style="background:#f9f8f5;border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
            <div style="font-size:24px;margin-bottom:8px;">üßπ</div>
            <strong style="font-size:14px;">Tetteh Osei Cleaning</strong>
            <p style="font-size:12px;color:var(--text-muted);margin-top:4px;">Cleaners list, deployments, and client contracts</p>
            <button class="btn btn-outline" style="margin-top:12px;width:100%;border-color:var(--tetteh);color:var(--tetteh);" onclick="exportExcel('cleaning')">‚¨á Export Cleaning</button>
          </div>
        </div>
      </div>

      <!-- JSON BACKUP -->
      <div class="grid-2">
        <div class="card">
          <div class="card-title">üíæ Full System Backup (JSON)</div>
          <p style="color:var(--text-muted);font-size:14px;margin-bottom:16px;">
            Export a complete backup of <strong>all your data</strong> including documents and receipts. Use this to restore your data on another device or browser, or to keep a safe copy.
          </p>
          <div class="alert alert-info">
            üí° <strong>Tip:</strong> Do this regularly ‚Äî especially before clearing your browser or switching computers.
          </div>
          <div style="display:flex;gap:10px;margin-top:16px;">
            <button class="btn btn-accent" style="flex:1;" onclick="exportBackup()">‚¨á Download Full Backup</button>
          </div>
          <div style="margin-top:10px;font-size:12px;color:var(--text-muted);" id="lastBackupInfo">No backup downloaded yet this session.</div>
        </div>

        <div class="card">
          <div class="card-title">üìÇ Restore from Backup</div>
          <p style="color:var(--text-muted);font-size:14px;margin-bottom:16px;">
            Import a previously downloaded <code>.json</code> backup file to restore all your data. This will <strong>replace</strong> all current data.
          </p>
          <div class="alert alert-warning">
            ‚ö†Ô∏è <strong>Warning:</strong> Restoring a backup will overwrite ALL current data in this browser. Make sure to back up first if needed.
          </div>
          <div class="upload-area" style="margin-top:16px;padding:20px;" onclick="document.getElementById('backupImportFile').click()">
            <div style="font-size:28px;">üìÅ</div>
            <p style="font-size:13px;">Click to select a .json backup file</p>
            <input type="file" id="backupImportFile" accept=".json" style="display:none;" onchange="importBackup(this)">
          </div>
          <div id="importStatus" style="margin-top:12px;font-size:13px;"></div>
        </div>
      </div>

      <!-- EXCEL IMPORT -->
      <div class="card mt-16">
        <div class="card-title">üì• Import from Excel</div>
        <p style="color:var(--text-muted);font-size:14px;margin-bottom:16px;">
          Import data from an Excel file exported by this system. Select the sheet type below, then upload the file.
        </p>
        <div class="form-row cols-3">
          <div class="field">
            <label>Sheet / Data Type</label>
            <select id="excelImportType">
              <option value="income">Income Records</option>
              <option value="expenditure">Expenditure Records</option>
              <option value="staff">Payroll / Staff</option>
              <option value="cleaners">Cleaners</option>
              <option value="ecoSales">Eco-Power Sales</option>
            </select>
          </div>
          <div class="field">
            <label>Excel File (.xlsx)</label>
            <input type="file" id="excelImportFile" accept=".xlsx,.xls,.csv">
          </div>
          <div class="field" style="display:flex;align-items:flex-end;">
            <button class="btn btn-green" style="width:100%;" onclick="importFromExcel()">üì• Import Data</button>
          </div>
        </div>
        <div id="excelImportStatus" style="margin-top:12px;font-size:13px;"></div>
      </div>
    </div>

  </div><!-- end main-content -->
</div><!-- end app -->

<!-- ========== MODALS ========== -->

<!-- INCOME MODAL -->
<div class="modal-overlay" id="incomeModal">
  <div class="modal">
    <div class="modal-header"><h3>Record Income</h3><button class="modal-close" onclick="closeModal('incomeModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Entity *</label>
          <select id="inc_entity">
            <option value="martinas">Martinas Company Limited</option>
            <option value="tetteh">Tetteh Osei Cleaning Services</option>
            <option value="ecopower">Eco-Power</option>
          </select>
        </div>
        <div class="field"><label>Date *</label><input type="date" id="inc_date"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Category *</label>
          <select id="inc_cat">
            <option value="Project Revenue">Project Revenue</option>
            <option value="Service Charges">Service Charges</option>
            <option value="Rent Income">Rent Income</option>
            <option value="Sales Revenue">Sales Revenue</option>
            <option value="Consulting Fees">Consulting Fees</option>
            <option value="Interest Income">Interest Income</option>
            <option value="Other Income">Other Income</option>
          </select>
        </div>
        <div class="field"><label>Amount (GHS) *</label><input type="number" id="inc_amount" placeholder="0.00" min="0" step="0.01"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Description *</label><input type="text" id="inc_desc" placeholder="Brief description of income"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Reference / Invoice No.</label><input type="text" id="inc_ref" placeholder="INV-0001"></div>
        <div class="field"><label>Received From</label><input type="text" id="inc_from" placeholder="Client/Customer name"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Attach Receipt/Invoice (optional)</label>
          <input type="file" id="inc_receipt" accept="image/*,application/pdf">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('incomeModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveIncome()">Save Income</button>
    </div>
  </div>
</div>

<!-- EXPENDITURE MODAL -->
<div class="modal-overlay" id="expModal">
  <div class="modal">
    <div class="modal-header"><h3>Record Expenditure</h3><button class="modal-close" onclick="closeModal('expModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Entity *</label>
          <select id="exp_entity">
            <option value="martinas">Martinas Company Limited</option>
            <option value="tetteh">Tetteh Osei Cleaning Services</option>
            <option value="ecopower">Eco-Power</option>
          </select>
        </div>
        <div class="field"><label>Date *</label><input type="date" id="exp_date"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Category *</label>
          <select id="exp_cat">
            <option value="Salaries & Wages">Salaries & Wages</option>
            <option value="Rent & Utilities">Rent & Utilities</option>
            <option value="Materials & Supplies">Materials & Supplies</option>
            <option value="Transportation">Transportation</option>
            <option value="Equipment">Equipment</option>
            <option value="Marketing">Marketing</option>
            <option value="Professional Fees">Professional Fees</option>
            <option value="Insurance">Insurance</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Bank Charges">Bank Charges</option>
            <option value="Taxes">Taxes</option>
            <option value="Stock Purchase">Stock Purchase</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="field"><label>Amount (GHS) *</label><input type="number" id="exp_amount" placeholder="0.00" min="0" step="0.01"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Description *</label><input type="text" id="exp_desc" placeholder="Brief description of expense"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Vendor / Payee</label><input type="text" id="exp_vendor" placeholder="Supplier/vendor name"></div>
        <div class="field"><label>Payment Method</label>
          <select id="exp_method">
            <option>Cash</option><option>Bank Transfer</option><option>Cheque</option><option>Mobile Money</option><option>Card</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="field"><label>Attach Receipt/Invoice (optional)</label>
          <input type="file" id="exp_receipt" accept="image/*,application/pdf">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('expModal')">Cancel</button>
      <button class="btn btn-red" onclick="saveExp()">Save Expense</button>
    </div>
  </div>
</div>

<!-- PETTY CASH MODAL -->
<div class="modal-overlay" id="pettyModal">
  <div class="modal">
    <div class="modal-header"><h3>Petty Cash Entry</h3><button class="modal-close" onclick="closeModal('pettyModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Type</label>
          <select id="petty_type">
            <option value="expense">Expense (Out)</option>
            <option value="income">Income (In)</option>
          </select>
        </div>
        <div class="field"><label>Date *</label><input type="date" id="petty_date"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Amount (GHS) *</label><input type="number" id="petty_amount" placeholder="0.00" min="0" step="0.01"></div>
        <div class="field"><label>Authorized By</label><input type="text" id="petty_auth" placeholder="Name of authorizer"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Description *</label><input type="text" id="petty_desc" placeholder="Purpose of petty cash"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Receipt (optional)</label><input type="file" id="petty_receipt" accept="image/*"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('pettyModal')">Cancel</button>
      <button class="btn btn-accent" onclick="savePetty()">Save Entry</button>
    </div>
  </div>
</div>

<!-- FUND PETTY MODAL -->
<div class="modal-overlay" id="fundPettyModal">
  <div class="modal">
    <div class="modal-header"><h3>Fund Petty Cash Float</h3><button class="modal-close" onclick="closeModal('fundPettyModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Amount to Add (GHS)</label><input type="number" id="fund_amount" placeholder="0.00" min="0" step="0.01"></div>
        <div class="field"><label>Date</label><input type="date" id="fund_date"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Notes</label><input type="text" id="fund_notes" placeholder="Fund replenishment notes"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('fundPettyModal')">Cancel</button>
      <button class="btn btn-green" onclick="fundPetty()">Add Funds</button>
    </div>
  </div>
</div>

<!-- STAFF MODAL -->
<div class="modal-overlay" id="staffModal">
  <div class="modal modal-lg">
    <div class="modal-header"><h3>Add Staff to Payroll</h3><button class="modal-close" onclick="closeModal('staffModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Entity *</label>
          <select id="staff_entity">
            <option value="martinas">Martinas Company Limited</option>
            <option value="tetteh">Tetteh Osei Cleaning Services</option>
            <option value="ecopower">Eco-Power</option>
          </select>
        </div>
        <div class="field"><label>Full Name *</label><input type="text" id="staff_name" placeholder="Employee full name"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Position / Role</label><input type="text" id="staff_role" placeholder="e.g. Site Engineer, Cleaner"></div>
        <div class="field"><label>Branch / Location</label><input type="text" id="staff_branch" placeholder="e.g. Accra HQ, East Legon"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Contact Number *</label><input type="text" id="staff_phone" placeholder="0XX XXX XXXX"></div>
        <div class="field"><label>Start Date</label><input type="date" id="staff_startdate"></div>
      </div>
      <div class="form-row cols-3">
        <div class="field"><label>Bank Name</label><input type="text" id="staff_bank" placeholder="e.g. GCB, Ecobank"></div>
        <div class="field"><label>Account Number</label><input type="text" id="staff_acct" placeholder="Bank account number"></div>
        <div class="field"><label>Gross Salary (GHS) *</label><input type="number" id="staff_salary" placeholder="0.00" min="0" step="0.01"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>SSNIT Number (optional)</label><input type="text" id="staff_ssnit" placeholder="SSNIT number"></div>
        <div class="field"><label>TIN (optional)</label><input type="text" id="staff_tin" placeholder="Tax ID number"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('staffModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveStaff()">Add to Payroll</button>
    </div>
  </div>
</div>

<!-- ASSET MODAL -->
<div class="modal-overlay" id="assetModal">
  <div class="modal">
    <div class="modal-header"><h3>Add Asset</h3><button class="modal-close" onclick="closeModal('assetModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Entity *</label>
          <select id="asset_entity">
            <option value="martinas">Martinas Company Limited</option>
            <option value="tetteh">Tetteh Osei Cleaning Services</option>
            <option value="ecopower">Eco-Power</option>
          </select>
        </div>
        <div class="field"><label>Asset Name *</label><input type="text" id="asset_name" placeholder="e.g. Toyota Hilux, Laptop"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Category</label>
          <select id="asset_cat">
            <option>Land & Buildings</option><option>Motor Vehicles</option><option>Equipment & Machinery</option>
            <option>Furniture & Fixtures</option><option>Computer Equipment</option><option>Other</option>
          </select>
        </div>
        <div class="field"><label>Purchase Date</label><input type="date" id="asset_date"></div>
      </div>
      <div class="form-row cols-3">
        <div class="field"><label>Cost (GHS) *</label><input type="number" id="asset_cost" placeholder="0.00" min="0" step="0.01"></div>
        <div class="field"><label>Useful Life (yrs)</label><input type="number" id="asset_life" placeholder="5" min="1"></div>
        <div class="field"><label>Salvage Value (GHS)</label><input type="number" id="asset_salvage" placeholder="0.00" min="0" step="0.01"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Description</label><input type="text" id="asset_desc" placeholder="Asset description/location"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('assetModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveAsset()">Save Asset</button>
    </div>
  </div>
</div>

<!-- LIABILITY MODAL -->
<div class="modal-overlay" id="liabilityModal">
  <div class="modal">
    <div class="modal-header"><h3>Add Liability</h3><button class="modal-close" onclick="closeModal('liabilityModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Entity *</label>
          <select id="liab_entity">
            <option value="martinas">Martinas Company Limited</option>
            <option value="tetteh">Tetteh Osei Cleaning Services</option>
            <option value="ecopower">Eco-Power</option>
          </select>
        </div>
        <div class="field"><label>Description *</label><input type="text" id="liab_desc" placeholder="e.g. Bank Loan, Trade Payable"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Amount (GHS) *</label><input type="number" id="liab_amount" placeholder="0.00" min="0" step="0.01"></div>
        <div class="field"><label>Due Date</label><input type="date" id="liab_due"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Creditor</label><input type="text" id="liab_creditor" placeholder="Name of creditor/lender"></div>
        <div class="field"><label>Type</label>
          <select id="liab_type">
            <option>Bank Loan</option><option>Trade Payable</option><option>Accrued Expense</option>
            <option>Tax Payable</option><option>Deferred Revenue</option><option>Other</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('liabilityModal')">Cancel</button>
      <button class="btn btn-red" onclick="saveLiability()">Save Liability</button>
    </div>
  </div>
</div>

<!-- ECO STOCK MODAL -->
<div class="modal-overlay" id="ecoStockModal">
  <div class="modal">
    <div class="modal-header"><h3>Add / Update Stock</h3><button class="modal-close" onclick="closeModal('ecoStockModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Product Name *</label><input type="text" id="ecostock_name" placeholder="e.g. Eco-Power Box 1L"></div>
        <div class="field"><label>Unit Type</label>
          <select id="ecostock_unit"><option>Box</option><option>Canister</option><option>Bottle</option><option>Litre</option></select>
        </div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Quantity to Add</label><input type="number" id="ecostock_qty" placeholder="0" min="0"></div>
        <div class="field"><label>Cost per Unit (GHS)</label><input type="number" id="ecostock_cost" placeholder="0.00" step="0.01"></div>
      </div>
      <div class="form-row cols-3">
        <div class="field"><label>Retail Price (GHS)</label><input type="number" id="ecostock_retail" placeholder="0.00" step="0.01"></div>
        <div class="field"><label>Wholesale Price (GHS)</label><input type="number" id="ecostock_wholesale" placeholder="0.00" step="0.01"></div>
        <div class="field"><label>Dealer Price (GHS)</label><input type="number" id="ecostock_dealer" placeholder="0.00" step="0.01"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Reorder Level</label><input type="number" id="ecostock_reorder" placeholder="10" min="0"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('ecoStockModal')">Cancel</button>
      <button class="btn btn-accent" onclick="saveEcoStock()">Save Stock</button>
    </div>
  </div>
</div>

<!-- ECO SALE MODAL -->
<div class="modal-overlay" id="ecoSaleModal">
  <div class="modal modal-lg">
    <div class="modal-header"><h3>Record Eco-Power Sale</h3><button class="modal-close" onclick="closeModal('ecoSaleModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Date *</label><input type="date" id="ecosale_date"></div>
        <div class="field"><label>Customer Name *</label><input type="text" id="ecosale_cust" placeholder="Customer name"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Customer Type</label>
          <select id="ecosale_custtype" onchange="autoSetEcoPrice()">
            <option value="individual">Individual (Retail)</option>
            <option value="corporate">Corporate (Wholesale)</option>
            <option value="dealer">Dealer</option>
          </select>
        </div>
        <div class="field"><label>Product</label>
          <select id="ecosale_product" onchange="autoSetEcoPrice()"><option value="">-- Select Product --</option></select>
        </div>
      </div>
      <div class="form-row cols-3">
        <div class="field"><label>Quantity *</label><input type="number" id="ecosale_qty" placeholder="0" min="1" oninput="calcEcoTotal()"></div>
        <div class="field"><label>Unit Price (GHS)</label><input type="number" id="ecosale_price" placeholder="0.00" step="0.01" oninput="calcEcoTotal()"></div>
        <div class="field"><label>Total (GHS)</label><input type="number" id="ecosale_total" placeholder="0.00" readonly style="background:#f9f8f5;"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Payment Type</label>
          <select id="ecosale_paytype" onchange="toggleCreditFields()">
            <option value="cash">Cash (Full Payment)</option>
            <option value="credit">Credit</option>
            <option value="partial">Partial Payment</option>
          </select>
        </div>
        <div class="field"><label>Amount Paid (GHS)</label><input type="number" id="ecosale_paid" placeholder="0.00" step="0.01"></div>
      </div>
      <div id="creditFields" style="display:none;">
        <div class="form-row cols-2">
          <div class="field"><label>Credit Due Date</label><input type="date" id="ecosale_duedate"></div>
          <div class="field"><label>Customer Contact</label><input type="text" id="ecosale_contact" placeholder="Phone number"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="field"><label>Notes</label><input type="text" id="ecosale_notes" placeholder="Optional notes"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('ecoSaleModal')">Cancel</button>
      <button class="btn btn-accent" onclick="saveEcoSale()">Record Sale</button>
    </div>
  </div>
</div>

<!-- CLEANER MODAL -->
<div class="modal-overlay" id="cleanerModal">
  <div class="modal">
    <div class="modal-header"><h3>Add Cleaner</h3><button class="modal-close" onclick="closeModal('cleanerModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Full Name *</label><input type="text" id="cleaner_name" placeholder="Cleaner full name"></div>
        <div class="field"><label>Contact Number</label><input type="text" id="cleaner_phone" placeholder="0XX XXX XXXX"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Establishment / Client</label><input type="text" id="cleaner_estab" placeholder="Where they are deployed"></div>
        <div class="field"><label>Location</label><input type="text" id="cleaner_loc" placeholder="Area / City"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Monthly Pay (GHS)</label><input type="number" id="cleaner_pay" placeholder="0.00" step="0.01"></div>
        <div class="field"><label>Start Date</label><input type="date" id="cleaner_start"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Bank Name</label><input type="text" id="cleaner_bank" placeholder="Bank name"></div>
        <div class="field"><label>Account Number</label><input type="text" id="cleaner_acct" placeholder="Account number"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('cleanerModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveCleaner()">Add Cleaner</button>
    </div>
  </div>
</div>

<!-- CONTRACT MODAL -->
<div class="modal-overlay" id="contractModal">
  <div class="modal">
    <div class="modal-header"><h3>Add Client Contract</h3><button class="modal-close" onclick="closeModal('contractModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Client Name *</label><input type="text" id="contract_client" placeholder="Client/establishment name"></div>
        <div class="field"><label>Location</label><input type="text" id="contract_loc" placeholder="Client location"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>No. of Cleaners</label><input type="number" id="contract_cleaners" placeholder="0" min="1"></div>
        <div class="field"><label>Monthly Value (GHS)</label><input type="number" id="contract_value" placeholder="0.00" step="0.01"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Start Date</label><input type="date" id="contract_start"></div>
        <div class="field"><label>End Date (optional)</label><input type="date" id="contract_end"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Notes</label><textarea id="contract_notes" placeholder="Contract details"></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('contractModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveContract()">Save Contract</button>
    </div>
  </div>
</div>

<!-- UPLOAD MODAL -->
<div class="modal-overlay" id="uploadModal">
  <div class="modal">
    <div class="modal-header"><h3>Upload Receipt / Invoice</h3><button class="modal-close" onclick="closeModal('uploadModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Entity *</label>
          <select id="upload_entity">
            <option value="martinas">Martinas Company Limited</option>
            <option value="tetteh">Tetteh Osei Cleaning Services</option>
            <option value="ecopower">Eco-Power</option>
          </select>
        </div>
        <div class="field"><label>Document Type</label>
          <select id="upload_type"><option value="receipt">Receipt</option><option value="invoice">Invoice</option><option value="other">Other</option></select>
        </div>
      </div>
      <div class="form-row">
        <div class="field"><label>Description</label><input type="text" id="upload_desc" placeholder="Brief description"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Date</label><input type="date" id="upload_date"></div>
      </div>
      <div class="upload-area" onclick="document.getElementById('upload_file').click()">
        <div class="upload-icon">üìÅ</div>
        <p>Click to select file or drag & drop</p>
        <p style="font-size:12px;margin-top:4px;">Supports: JPG, PNG, PDF</p>
        <input type="file" id="upload_file" style="display:none;" accept="image/*,application/pdf" onchange="previewUpload(this)">
      </div>
      <div id="upload_preview" style="margin-top:12px;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('uploadModal')">Cancel</button>
      <button class="btn btn-accent" onclick="saveDoc()">Upload Document</button>
    </div>
  </div>
</div>

<!-- USER MODAL -->
<div class="modal-overlay" id="userModal">
  <div class="modal">
    <div class="modal-header"><h3>Add User</h3><button class="modal-close" onclick="closeModal('userModal')">√ó</button></div>
    <div class="modal-body">
      <div class="form-row cols-2">
        <div class="field"><label>Full Name *</label><input type="text" id="user_name" placeholder="User full name"></div>
        <div class="field"><label>Email *</label><input type="email" id="user_email" placeholder="user@example.com"></div>
      </div>
      <div class="form-row cols-2">
        <div class="field"><label>Password *</label><input type="password" id="user_pass" placeholder="Set password"></div>
        <div class="field"><label>Role</label>
          <select id="user_role">
            <option value="manager">Manager</option>
            <option value="clerk">Clerk</option>
            <option value="viewer">Viewer (Read-only)</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="field"><label>Entities Access</label>
          <div style="display:flex;gap:16px;margin-top:6px;">
            <label style="text-transform:none;font-size:14px;display:flex;align-items:center;gap:6px;"><input type="checkbox" id="ua_martinas" checked> Martinas</label>
            <label style="text-transform:none;font-size:14px;display:flex;align-items:center;gap:6px;"><input type="checkbox" id="ua_tetteh"> Tetteh Osei</label>
            <label style="text-transform:none;font-size:14px;display:flex;align-items:center;gap:6px;"><input type="checkbox" id="ua_ecopower"> Eco-Power</label>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('userModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveUser()">Create User</button>
    </div>
  </div>
</div>

<!-- IMAGE VIEWER MODAL -->
<div class="modal-overlay" id="imgViewer">
  <div class="modal" style="max-width:90vw;max-height:90vh;overflow:auto;">
    <div class="modal-header"><h3>Document Viewer</h3><button class="modal-close" onclick="closeModal('imgViewer')">√ó</button></div>
    <div class="modal-body" style="text-align:center;">
      <img id="viewerImg" style="max-width:100%;max-height:70vh;object-fit:contain;" src="">
    </div>
  </div>
</div>

<!-- NOTIFICATION -->
<div id="notification" style="position:fixed;top:20px;right:20px;z-index:9999;min-width:280px;display:none;border-radius:10px;padding:14px 18px;font-size:14px;font-weight:500;box-shadow:var(--shadow-lg);transition:all 0.3s;"></div>

<script>
// ============================================================
// DATA LAYER ‚Äî localStorage persistence
// ============================================================
const DB_KEY = 'martinas_eas_v2';

function db() {
  const raw = localStorage.getItem(DB_KEY);
  return raw ? JSON.parse(raw) : null;
}

function dbSave(data) {
  localStorage.setItem(DB_KEY, JSON.stringify(data));
}

function initDB() {
  const today = new Date().toISOString().slice(0,10);
  const data = {
    users: [],
    income: [],
    expenditure: [],
    petty: { martinas: { balance: 0, entries: [] }, tetteh: { balance: 0, entries: [] }, ecopower: { balance: 0, entries: [] } },
    assets: [],
    liabilities: [],
    staff: [],
    ecoProducts: [],
    ecoSales: [],
    cleaners: [],
    contracts: [],
    docs: [],
    auditLog: []
  };
  return data;
}

// Current user & state
let currentUser = null;
let currentPettyEntity = 'martinas';
let currentIncomeEntity = 'all';
let currentExpEntity = 'all';
let currentAssetsEntity = 'all';
let currentPayrollEntity = 'all';
let currentDocsEntity = 'all';

// ============================================================
// BOOT
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  const data = db();
  if (!data) {
    // First time ‚Äî show setup
    document.getElementById('setupScreen').style.display = 'flex';
  } else {
    document.getElementById('loginScreen').style.display = 'flex';
  }
  // Set today's date in form fields
  const today = new Date().toISOString().slice(0, 10);
  document.querySelectorAll('input[type=date]').forEach(el => { if (!el.value) el.value = today; });
  document.getElementById('dashDate').textContent = new Date().toLocaleDateString('en-GH', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
});

// ============================================================
// SETUP
// ============================================================
function completeSetup() {
  const name = document.getElementById('setupName').value.trim();
  const email = document.getElementById('setupEmail').value.trim();
  const pass = document.getElementById('setupPass').value;
  const pass2 = document.getElementById('setupPass2').value;
  const err = document.getElementById('setupError');
  
  if (!name || !email || !pass) { err.style.display='block'; err.textContent='All fields are required.'; return; }
  if (pass !== pass2) { err.style.display='block'; err.textContent='Passwords do not match.'; return; }
  if (pass.length < 6) { err.style.display='block'; err.textContent='Password must be at least 6 characters.'; return; }
  
  const data = initDB();
  data.users.push({
    id: uid(), name, email, password: btoa(pass), role: 'owner',
    entities: ['martinas','tetteh','ecopower'], active: true, created: new Date().toISOString()
  });
  data.auditLog.push({ id: uid(), ts: new Date().toISOString(), user: name, action: 'System Setup', entity: 'System', details: 'Initial admin account created' });
  dbSave(data);
  
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  notify('Account created! Please login.', 'success');
}

// ============================================================
// AUTH
// ============================================================
function doLogin() {
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const pass = document.getElementById('loginPassword').value;
  const data = db();
  
  const user = data.users.find(u => u.email.toLowerCase() === email && u.password === btoa(pass) && u.active !== false);
  if (!user) {
    document.getElementById('loginError').style.display = 'block';
    return;
  }
  
  currentUser = user;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  
  document.getElementById('sidebarAvatar').textContent = user.name.charAt(0).toUpperCase();
  document.getElementById('sidebarName').textContent = user.name;
  document.getElementById('sidebarRole').textContent = user.role === 'owner' ? 'Owner / Admin' : user.role.charAt(0).toUpperCase() + user.role.slice(1);
  
  // Hide admin nav for non-owners
  if (user.role !== 'owner' && user.role !== 'manager') {
    document.getElementById('adminNav').style.display = 'none';
  }
  
  addAudit('Login', 'System', 'User signed in');
  refreshDashboard();
  populateMonthFilters();
  populateEcoProductDropdown();
}

function doLogout() {
  addAudit('Logout', 'System', 'User signed out');
  currentUser = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginError').style.display = 'none';
}

// ============================================================
// NAVIGATION
// ============================================================
function showSection(name) {
  document.querySelectorAll('.section-page').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('sec-' + name).classList.add('active');
  event && event.currentTarget && event.currentTarget.classList && event.currentTarget.classList.add('active');
  // Also update nav
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick') && n.getAttribute('onclick').includes("'" + name + "'")) n.classList.add('active');
  });
  
  // Refresh relevant section
  if (name === 'dashboard') refreshDashboard();
  if (name === 'income') renderIncome();
  if (name === 'expenditure') renderExp();
  if (name === 'petty') renderPetty();
  if (name === 'assets') renderAssets();
  if (name === 'payroll') renderPayroll();
  if (name === 'ecopower') renderEcoAll();
  if (name === 'cleaning') { renderCleaners(); renderContracts(); }
  if (name === 'receipts') renderDocs();
  if (name === 'users') renderUsers();
  if (name === 'audit') renderAudit();
  if (name === 'backup') renderBackup();
}

// ============================================================
// UTILS
// ============================================================
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function fmt(n) { return 'GHS ' + Number(n||0).toLocaleString('en-GH',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtN(n) { return Number(n||0).toLocaleString('en-GH',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function today() { return new Date().toISOString().slice(0,10); }

function notify(msg, type='success') {
  const el = document.getElementById('notification');
  const colors = { success: '#16a34a', danger: '#dc2626', warning: '#d97706', info: '#2563eb' };
  const bgs = { success: '#f0fdf4', danger: '#fef2f2', warning: '#fffbeb', info: '#eff6ff' };
  el.style.background = bgs[type] || bgs.success;
  el.style.color = colors[type] || colors.success;
  el.style.border = `1px solid ${colors[type] || colors.success}`;
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 3500);
}

function openModal(id) {
  document.getElementById(id).classList.add('show');
  const d = today();
  document.querySelectorAll('#' + id + ' input[type=date]').forEach(el => { if (!el.value) el.value = d; });
}
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function addAudit(action, entity, details) {
  const data = db();
  data.auditLog.unshift({ id: uid(), ts: new Date().toISOString(), user: currentUser ? currentUser.name : 'System', action, entity, details });
  if (data.auditLog.length > 500) data.auditLog = data.auditLog.slice(0, 500);
  dbSave(data);
}

function entityLabel(e) {
  return { martinas: 'Martinas', tetteh: 'Tetteh Osei', ecopower: 'Eco-Power', all: 'All' }[e] || e;
}

function entityBadge(e) {
  const cls = { martinas: 'badge-martinas', tetteh: 'badge-tetteh', ecopower: 'badge-ecopower' }[e] || 'badge-info';
  return `<span class="badge ${cls}">${entityLabel(e)}</span>`;
}

function fileToBase64(file) {
  return new Promise((res,rej) => {
    const reader = new FileReader();
    reader.onload = e => res(e.target.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

function populateMonthFilters() {
  const months = [];
  const now = new Date();
  for (let i = 0; i < 24; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const val = d.toISOString().slice(0,7);
    months.push({ val, label: d.toLocaleDateString('en-GH',{year:'numeric',month:'long'}) });
  }
  ['incomeMonthFilter','expMonthFilter','ecoMonthFilter'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = '<option value="">All Months</option>' + months.map(m => `<option value="${m.val}">${m.label}</option>`).join('');
  });
}

// ============================================================
// DASHBOARD
// ============================================================
function refreshDashboard() {
  const data = db();
  if (!data) return;
  
  const now = new Date();
  const thisMonth = now.toISOString().slice(0,7);
  
  // Income & expenditure totals
  const incAll = data.income.reduce((s,r) => s + Number(r.amount), 0);
  const expAll = data.expenditure.reduce((s,r) => s + Number(r.amount), 0);
  const incMonth = data.income.filter(r=>r.date.startsWith(thisMonth)).reduce((s,r) => s + Number(r.amount), 0);
  const expMonth = data.expenditure.filter(r=>r.date.startsWith(thisMonth)).reduce((s,r) => s + Number(r.amount), 0);
  const profit = incAll - expAll;
  
  // Entity-level stats
  const entities = ['martinas','tetteh','ecopower'];
  const entityNames = { martinas: 'Martinas Co. Ltd.', tetteh: 'Tetteh Osei Cleaning', ecopower: 'Eco-Power' };
  const entityColors = { martinas: 'var(--martinas)', tetteh: 'var(--tetteh)', ecopower: 'var(--ecopower)' };
  
  document.getElementById('entityStats').innerHTML = entities.map(e => {
    const eInc = data.income.filter(r=>r.entity===e).reduce((s,r)=>s+Number(r.amount),0);
    const eExp = data.expenditure.filter(r=>r.entity===e).reduce((s,r)=>s+Number(r.amount),0);
    const eProfit = eInc - eExp;
    return `<div class="stat-card" style="border-top:3px solid ${entityColors[e]}">
      <div class="label">${entityNames[e]}</div>
      <div class="value" style="font-size:20px;color:${entityColors[e]};">${fmt(eInc)}</div>
      <div class="sub">Income ‚Ä¢ Expenses: ${fmt(eExp)} ‚Ä¢ Net: <span class="${eProfit>=0?'trend-up':'trend-down'}">${fmt(eProfit)}</span></div>
    </div>`;
  }).join('');
  
  document.getElementById('summaryStats').innerHTML = `
    <div class="stat-card accent"><div class="label">Total Income (All Time)</div><div class="value">${fmtN(incAll)}</div><div class="sub">This month: ${fmt(incMonth)}</div></div>
    <div class="stat-card red"><div class="label">Total Expenditure</div><div class="value">${fmtN(expAll)}</div><div class="sub">This month: ${fmt(expMonth)}</div></div>
    <div class="stat-card ${profit>=0?'green':'red'}"><div class="label">Net Profit / Loss</div><div class="value" class="${profit>=0?'text-success':'text-danger'}">${fmtN(profit)}</div><div class="sub">Overall position</div></div>
    <div class="stat-card blue"><div class="label">Total Staff</div><div class="value">${data.staff.filter(s=>s.status!=='inactive').length + data.cleaners.length}</div><div class="sub">Active payroll members</div></div>
  `;
  
  // Revenue chart
  const chartData = entities.map(e => ({
    entity: e,
    amount: data.income.filter(r=>r.entity===e && r.date.startsWith(thisMonth)).reduce((s,r)=>s+Number(r.amount),0),
    color: entityColors[e]
  }));
  const maxAmount = Math.max(...chartData.map(c=>c.amount), 1);
  document.getElementById('revenueChart').innerHTML = chartData.map(c => {
    const pct = Math.max((c.amount/maxAmount)*100, 3);
    return `<div class="chart-bar" style="background:${c.color};height:${pct}%;">
      <span class="bar-val" style="color:${c.color}">${c.amount>0?fmtN(c.amount):''}</span>
      <span class="bar-label">${entityLabel(c.entity)}</span>
    </div>`;
  }).join('');
  
  // Recent activity
  document.getElementById('recentActivity').innerHTML = data.auditLog.slice(0,8).map(a => {
    const colors = { Income: 'var(--success)', Expenditure: 'var(--danger)', Payroll: 'var(--info)', 'Eco-Power': 'var(--ecopower)' };
    const color = colors[a.action] || 'var(--text-muted)';
    return `<div class="activity-item">
      <div class="activity-dot" style="background:${color}"></div>
      <div><div style="font-weight:500">${a.action}</div><div style="color:var(--text-muted);font-size:12px">${a.details} ‚Ä¢ ${new Date(a.ts).toLocaleDateString()}</div></div>
    </div>`;
  }).join('') || '<p style="color:var(--text-muted);font-size:13px">No recent activity</p>';
  
  // Eco stock
  const lowStock = data.ecoProducts.filter(p => Number(p.stock) <= Number(p.reorder));
  document.getElementById('dashEcoStock').innerHTML = data.ecoProducts.length === 0
    ? '<p style="color:var(--text-muted);font-size:13px">No products yet</p>'
    : data.ecoProducts.map(p => `<div class="flex-between mb-16" style="padding:8px 0;border-bottom:1px solid var(--border);">
        <div><div style="font-weight:600;font-size:13px">${p.name}</div><div style="font-size:11px;color:var(--text-muted)">${p.unit}</div></div>
        <div class="badge ${Number(p.stock)<=Number(p.reorder)?'badge-danger':'badge-success'}">${p.stock} units</div>
      </div>`).join('');
  
  // Cleaners
  const activeCleaners = data.cleaners.filter(c=>c.status!=='inactive');
  document.getElementById('dashCleaners').innerHTML = `
    <div style="font-size:32px;font-weight:700;font-family:'DM Mono',monospace;color:var(--tetteh)">${activeCleaners.length}</div>
    <div style="font-size:13px;color:var(--text-muted)">Active cleaners deployed</div>
    <div style="margin-top:10px;font-size:13px">Contracts: <strong>${data.contracts.filter(c=>c.status==='active').length}</strong> active</div>
    <div style="font-size:13px">Monthly payroll: <strong>${fmt(activeCleaners.reduce((s,c)=>s+Number(c.pay||0),0))}</strong></div>
  `;
  
  // Petty cash
  const pettyCash = db().petty;
  document.getElementById('dashPettyCash').innerHTML = entities.map(e => {
    const bal = pettyCash[e] ? pettyCash[e].balance : 0;
    return `<div class="flex-between" style="padding:6px 0;border-bottom:1px solid var(--border);">
      ${entityBadge(e)} <strong class="mono">${fmt(bal)}</strong>
    </div>`;
  }).join('');
}

// ============================================================
// INCOME
// ============================================================
function filterIncomeEntity(entity, el) {
  currentIncomeEntity = entity;
  document.querySelectorAll('#sec-income .entity-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderIncome();
}

function renderIncome() {
  const data = db();
  const search = document.getElementById('incomeSearch').value.toLowerCase();
  const month = document.getElementById('incomeMonthFilter').value;
  
  let records = data.income;
  if (currentIncomeEntity !== 'all') records = records.filter(r => r.entity === currentIncomeEntity);
  if (search) records = records.filter(r => JSON.stringify(r).toLowerCase().includes(search));
  if (month) records = records.filter(r => r.date.startsWith(month));
  
  records = [...records].sort((a,b) => b.date.localeCompare(a.date));
  
  const totals = { martinas:0, tetteh:0, ecopower:0 };
  data.income.forEach(r => totals[r.entity] = (totals[r.entity]||0) + Number(r.amount));
  
  document.getElementById('incomeSummary').innerHTML = `
    <div class="stat-card" style="border-top:3px solid var(--martinas);"><div class="label">Martinas</div><div class="value" style="font-size:18px">${fmtN(totals.martinas)}</div></div>
    <div class="stat-card" style="border-top:3px solid var(--tetteh);"><div class="label">Tetteh Osei</div><div class="value" style="font-size:18px">${fmtN(totals.tetteh)}</div></div>
    <div class="stat-card" style="border-top:3px solid var(--ecopower);"><div class="label">Eco-Power</div><div class="value" style="font-size:18px">${fmtN(totals.ecopower)}</div></div>
  `;
  
  const total = records.reduce((s,r) => s+Number(r.amount),0);
  document.getElementById('incomeBody').innerHTML = records.map(r => `
    <tr>
      <td>${r.date}</td>
      <td>${entityBadge(r.entity)}</td>
      <td><span class="badge badge-info">${r.category}</span></td>
      <td>${r.description}</td>
      <td style="font-family:'DM Mono',monospace;font-size:12px">${r.reference||'‚Äî'}</td>
      <td>${r.receipt ? `<img src="${r.receipt}" class="receipt-thumb" onclick="viewImg('${r.receipt}')">` : '‚Äî'}</td>
      <td class="text-right mono text-success"><strong>${fmtN(r.amount)}</strong></td>
      <td><button class="btn btn-red btn-sm" onclick="deleteRecord('income','${r.id}')">üóë</button></td>
    </tr>
  `).join('') || '<tr><td colspan="8" class="text-center text-muted" style="padding:24px">No income records found</td></tr>';
  
  document.getElementById('incomeTotalRow').innerHTML = `Total: GHS ${fmtN(total)}`;
}

async function saveIncome() {
  const entity = document.getElementById('inc_entity').value;
  const date = document.getElementById('inc_date').value;
  const category = document.getElementById('inc_cat').value;
  const amount = document.getElementById('inc_amount').value;
  const description = document.getElementById('inc_desc').value;
  const reference = document.getElementById('inc_ref').value;
  const from = document.getElementById('inc_from').value;
  const file = document.getElementById('inc_receipt').files[0];
  
  if (!date || !amount || !description) { notify('Please fill required fields', 'danger'); return; }
  
  let receipt = null;
  if (file) receipt = await fileToBase64(file);
  
  const data = db();
  const record = { id: uid(), entity, date, category, amount: Number(amount), description, reference, from, receipt, createdBy: currentUser.name, createdAt: new Date().toISOString() };
  data.income.push(record);
  dbSave(data);
  addAudit('Income', entityLabel(entity), `${description} ‚Äî GHS ${amount}`);
  closeModal('incomeModal');
  document.getElementById('inc_amount').value = '';
  document.getElementById('inc_desc').value = '';
  document.getElementById('inc_ref').value = '';
  document.getElementById('inc_from').value = '';
  document.getElementById('inc_receipt').value = '';
  renderIncome();
  notify('Income recorded successfully!');
}

// ============================================================
// EXPENDITURE
// ============================================================
function filterExpEntity(entity, el) {
  currentExpEntity = entity;
  document.querySelectorAll('#sec-expenditure .entity-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderExp();
}

function renderExp() {
  const data = db();
  const search = document.getElementById('expSearch').value.toLowerCase();
  const month = document.getElementById('expMonthFilter').value;
  
  let records = data.expenditure;
  if (currentExpEntity !== 'all') records = records.filter(r => r.entity === currentExpEntity);
  if (search) records = records.filter(r => JSON.stringify(r).toLowerCase().includes(search));
  if (month) records = records.filter(r => r.date.startsWith(month));
  
  records = [...records].sort((a,b) => b.date.localeCompare(a.date));
  
  const totals = { martinas:0, tetteh:0, ecopower:0 };
  data.expenditure.forEach(r => totals[r.entity] = (totals[r.entity]||0) + Number(r.amount));
  
  document.getElementById('expSummary').innerHTML = `
    <div class="stat-card" style="border-top:3px solid var(--martinas);"><div class="label">Martinas</div><div class="value" style="font-size:18px">${fmtN(totals.martinas)}</div></div>
    <div class="stat-card" style="border-top:3px solid var(--tetteh);"><div class="label">Tetteh Osei</div><div class="value" style="font-size:18px">${fmtN(totals.tetteh)}</div></div>
    <div class="stat-card" style="border-top:3px solid var(--ecopower);"><div class="label">Eco-Power</div><div class="value" style="font-size:18px">${fmtN(totals.ecopower)}</div></div>
  `;
  
  const total = records.reduce((s,r) => s+Number(r.amount),0);
  document.getElementById('expBody').innerHTML = records.map(r => `
    <tr>
      <td>${r.date}</td>
      <td>${entityBadge(r.entity)}</td>
      <td><span class="badge badge-warning">${r.category}</span></td>
      <td>${r.description}</td>
      <td>${r.vendor||'‚Äî'}</td>
      <td>${r.receipt ? `<img src="${r.receipt}" class="receipt-thumb" onclick="viewImg('${r.receipt}')">` : '‚Äî'}</td>
      <td class="text-right mono text-danger"><strong>${fmtN(r.amount)}</strong></td>
      <td><button class="btn btn-red btn-sm" onclick="deleteRecord('expenditure','${r.id}')">üóë</button></td>
    </tr>
  `).join('') || '<tr><td colspan="8" class="text-center text-muted" style="padding:24px">No expense records found</td></tr>';
  
  document.getElementById('expTotalRow').innerHTML = `Total: GHS ${fmtN(total)}`;
}

async function saveExp() {
  const entity = document.getElementById('exp_entity').value;
  const date = document.getElementById('exp_date').value;
  const category = document.getElementById('exp_cat').value;
  const amount = document.getElementById('exp_amount').value;
  const description = document.getElementById('exp_desc').value;
  const vendor = document.getElementById('exp_vendor').value;
  const method = document.getElementById('exp_method').value;
  const file = document.getElementById('exp_receipt').files[0];
  
  if (!date || !amount || !description) { notify('Please fill required fields', 'danger'); return; }
  
  let receipt = null;
  if (file) receipt = await fileToBase64(file);
  
  const data = db();
  data.expenditure.push({ id: uid(), entity, date, category, amount: Number(amount), description, vendor, method, receipt, createdBy: currentUser.name, createdAt: new Date().toISOString() });
  dbSave(data);
  addAudit('Expenditure', entityLabel(entity), `${description} ‚Äî GHS ${amount}`);
  closeModal('expModal');
  document.getElementById('exp_amount').value = '';
  document.getElementById('exp_desc').value = '';
  document.getElementById('exp_vendor').value = '';
  document.getElementById('exp_receipt').value = '';
  renderExp();
  notify('Expense recorded!');
}

// ============================================================
// PETTY CASH
// ============================================================
function filterPettyEntity(entity, el) {
  currentPettyEntity = entity;
  document.querySelectorAll('#sec-petty .entity-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  const names = { martinas: 'Martinas Company Limited', tetteh: 'Tetteh Osei Cleaning Services', ecopower: 'Eco-Power Department' };
  document.getElementById('pettyEntity').textContent = names[entity];
  renderPetty();
}

function renderPetty() {
  const data = db();
  const e = currentPettyEntity;
  const pettyData = data.petty[e] || { balance: 0, entries: [] };
  document.getElementById('pettyBalance').textContent = fmt(pettyData.balance);
  
  const search = document.getElementById('pettySearch').value.toLowerCase();
  let entries = [...(pettyData.entries||[])];
  if (search) entries = entries.filter(r => JSON.stringify(r).toLowerCase().includes(search));
  entries = entries.sort((a,b) => b.date.localeCompare(a.date));
  
  let running = 0;
  const withBal = entries.slice().reverse().map(r => {
    running += r.type === 'income' ? Number(r.amount) : -Number(r.amount);
    return { ...r, runBal: running };
  }).reverse();
  
  document.getElementById('pettyBody').innerHTML = withBal.map(r => `
    <tr>
      <td>${r.date}</td>
      <td><span class="badge ${r.type==='income'?'badge-success':'badge-danger'}">${r.type==='income'?'IN':'OUT'}</span></td>
      <td>${r.description}</td>
      <td>${r.authorizedBy||'‚Äî'}</td>
      <td>${r.receipt ? `<img src="${r.receipt}" class="receipt-thumb" onclick="viewImg('${r.receipt}')">` : '‚Äî'}</td>
      <td class="text-right mono ${r.type==='income'?'text-success':'text-danger'}"><strong>${fmtN(r.amount)}</strong></td>
      <td class="text-right mono">${fmtN(r.runBal)}</td>
      <td><button class="btn btn-red btn-sm" onclick="deletePetty('${r.id}')">üóë</button></td>
    </tr>
  `).join('') || '<tr><td colspan="8" class="text-center text-muted" style="padding:24px">No petty cash entries</td></tr>';
}

async function savePetty() {
  const type = document.getElementById('petty_type').value;
  const date = document.getElementById('petty_date').value;
  const amount = parseFloat(document.getElementById('petty_amount').value);
  const desc = document.getElementById('petty_desc').value;
  const auth = document.getElementById('petty_auth').value;
  const file = document.getElementById('petty_receipt').files[0];
  
  if (!date || !amount || !desc) { notify('Please fill required fields', 'danger'); return; }
  
  let receipt = null;
  if (file) receipt = await fileToBase64(file);
  
  const data = db();
  const e = currentPettyEntity;
  if (!data.petty[e]) data.petty[e] = { balance: 0, entries: [] };
  
  if (type === 'expense' && data.petty[e].balance < amount) { notify('Insufficient petty cash balance!', 'danger'); return; }
  
  data.petty[e].balance += type === 'income' ? amount : -amount;
  data.petty[e].entries.push({ id: uid(), type, date, amount, description: desc, authorizedBy: auth, receipt, createdBy: currentUser.name });
  dbSave(data);
  addAudit('Petty Cash', entityLabel(e), `${type==='income'?'IN':'OUT'}: ${desc} ‚Äî GHS ${amount}`);
  closeModal('pettyModal');
  document.getElementById('petty_amount').value = '';
  document.getElementById('petty_desc').value = '';
  document.getElementById('petty_auth').value = '';
  renderPetty();
  notify('Petty cash entry saved!');
}

function fundPetty() {
  const amount = parseFloat(document.getElementById('fund_amount').value);
  const date = document.getElementById('fund_date').value;
  const notes = document.getElementById('fund_notes').value;
  
  if (!amount || amount <= 0) { notify('Enter a valid amount', 'danger'); return; }
  
  const data = db();
  const e = currentPettyEntity;
  if (!data.petty[e]) data.petty[e] = { balance: 0, entries: [] };
  data.petty[e].balance += amount;
  data.petty[e].entries.push({ id: uid(), type: 'income', date, amount, description: 'Float Replenishment' + (notes?' - '+notes:''), authorizedBy: currentUser.name, createdBy: currentUser.name });
  dbSave(data);
  addAudit('Petty Cash', entityLabel(e), `Float funded: GHS ${amount}`);
  closeModal('fundPettyModal');
  document.getElementById('fund_amount').value = '';
  document.getElementById('fund_notes').value = '';
  renderPetty();
  notify('Float funded successfully!');
}

function deletePetty(id) {
  if (!confirm('Delete this petty cash entry?')) return;
  const data = db();
  const e = currentPettyEntity;
  const entry = data.petty[e].entries.find(r => r.id === id);
  if (entry) {
    data.petty[e].balance -= entry.type === 'income' ? entry.amount : -entry.amount;
    data.petty[e].entries = data.petty[e].entries.filter(r => r.id !== id);
    dbSave(data);
    renderPetty();
    notify('Entry deleted', 'warning');
  }
}

// ============================================================
// ASSETS
// ============================================================
function filterAssetsEntity(entity, el) {
  currentAssetsEntity = entity;
  document.querySelectorAll('#sec-assets .entity-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderAssets();
}

function renderAssets() {
  const data = db();
  let assets = data.assets;
  let liabs = data.liabilities;
  if (currentAssetsEntity !== 'all') {
    assets = assets.filter(a => a.entity === currentAssetsEntity);
    liabs = liabs.filter(l => l.entity === currentAssetsEntity);
  }
  
  const totalCost = assets.reduce((s,a) => s+Number(a.cost),0);
  const totalNet = assets.reduce((s,a) => {
    const depYrs = (new Date() - new Date(a.purchaseDate)) / (365.25*24*60*60*1000);
    const dep = ((Number(a.cost) - Number(a.salvage||0)) / Number(a.usefulLife||1)) * depYrs;
    return s + Math.max(Number(a.cost) - dep, Number(a.salvage||0));
  }, 0);
  const totalLiab = liabs.reduce((s,l) => s+Number(l.amount),0);
  const netWorth = totalNet - totalLiab;
  
  document.getElementById('assetStats').innerHTML = `
    <div class="stat-card accent"><div class="label">Total Asset Cost</div><div class="value" style="font-size:18px">${fmtN(totalCost)}</div></div>
    <div class="stat-card green"><div class="label">Net Asset Value</div><div class="value" style="font-size:18px">${fmtN(totalNet)}</div></div>
    <div class="stat-card red"><div class="label">Total Liabilities</div><div class="value" style="font-size:18px">${fmtN(totalLiab)}</div></div>
    <div class="stat-card ${netWorth>=0?'green':'red'}"><div class="label">Net Worth</div><div class="value" style="font-size:18px">${fmtN(netWorth)}</div></div>
  `;
  
  document.getElementById('assetsBody').innerHTML = assets.map(a => {
    const depYrs = (new Date() - new Date(a.purchaseDate)) / (365.25*24*60*60*1000);
    const annualDep = (Number(a.cost) - Number(a.salvage||0)) / Number(a.usefulLife||1);
    const netVal = Math.max(Number(a.cost) - annualDep * depYrs, Number(a.salvage||0));
    return `<tr>
      <td><strong>${a.name}</strong><br><small class="text-muted">${a.category}</small></td>
      <td>${entityBadge(a.entity)}</td>
      <td>${a.purchaseDate}</td>
      <td class="mono">${fmtN(a.cost)}</td>
      <td class="mono">${fmtN(annualDep)}/yr</td>
      <td class="mono ${netVal<Number(a.cost)*0.2?'text-danger':'text-success'}">${fmtN(netVal)}</td>
      <td><button class="btn btn-red btn-sm" onclick="deleteRecord('assets','${a.id}')">üóë</button></td>
    </tr>`;
  }).join('') || '<tr><td colspan="7" class="text-center text-muted" style="padding:24px">No assets recorded</td></tr>';
  
  document.getElementById('liabilitiesBody').innerHTML = liabs.map(l => {
    const isOverdue = l.dueDate && new Date(l.dueDate) < new Date();
    return `<tr>
      <td><strong>${l.description}</strong><br><small class="text-muted">${l.creditor||''}</small></td>
      <td>${entityBadge(l.entity)}</td>
      <td class="${isOverdue?'text-danger':''}">${l.dueDate||'‚Äî'}</td>
      <td class="mono text-danger">${fmtN(l.amount)}</td>
      <td><span class="badge ${isOverdue?'badge-danger':'badge-warning'}">${isOverdue?'Overdue':'Outstanding'}</span></td>
      <td><button class="btn btn-red btn-sm" onclick="deleteRecord('liabilities','${l.id}')">üóë</button></td>
    </tr>`;
  }).join('') || '<tr><td colspan="6" class="text-center text-muted" style="padding:24px">No liabilities recorded</td></tr>';
}

function saveAsset() {
  const entity = document.getElementById('asset_entity').value;
  const name = document.getElementById('asset_name').value;
  const category = document.getElementById('asset_cat').value;
  const purchaseDate = document.getElementById('asset_date').value;
  const cost = document.getElementById('asset_cost').value;
  const usefulLife = document.getElementById('asset_life').value;
  const salvage = document.getElementById('asset_salvage').value;
  const description = document.getElementById('asset_desc').value;
  
  if (!name || !cost) { notify('Please fill required fields', 'danger'); return; }
  const data = db();
  data.assets.push({ id: uid(), entity, name, category, purchaseDate, cost: Number(cost), usefulLife: Number(usefulLife||5), salvage: Number(salvage||0), description, createdBy: currentUser.name });
  dbSave(data);
  addAudit('Asset Added', entityLabel(entity), `${name} ‚Äî GHS ${cost}`);
  closeModal('assetModal');
  renderAssets();
  notify('Asset saved!');
}

function saveLiability() {
  const entity = document.getElementById('liab_entity').value;
  const description = document.getElementById('liab_desc').value;
  const amount = document.getElementById('liab_amount').value;
  const dueDate = document.getElementById('liab_due').value;
  const creditor = document.getElementById('liab_creditor').value;
  const type = document.getElementById('liab_type').value;
  
  if (!description || !amount) { notify('Please fill required fields', 'danger'); return; }
  const data = db();
  data.liabilities.push({ id: uid(), entity, description, amount: Number(amount), dueDate, creditor, type, createdBy: currentUser.name });
  dbSave(data);
  addAudit('Liability Added', entityLabel(entity), `${description} ‚Äî GHS ${amount}`);
  closeModal('liabilityModal');
  renderAssets();
  notify('Liability saved!');
}

// ============================================================
// PAYROLL
// ============================================================
function filterPayrollEntity(entity, el) {
  currentPayrollEntity = entity;
  document.querySelectorAll('#sec-payroll .entity-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderPayroll();
}

function renderPayroll() {
  const data = db();
  const search = document.getElementById('payrollSearch').value.toLowerCase();
  const statusF = document.getElementById('payrollStatusFilter').value;
  
  let staff = data.staff;
  if (currentPayrollEntity !== 'all') staff = staff.filter(s => s.entity === currentPayrollEntity);
  if (search) staff = staff.filter(s => JSON.stringify(s).toLowerCase().includes(search));
  if (statusF) staff = staff.filter(s => (s.status||'active') === statusF);
  
  const totals = { martinas:0, tetteh:0, ecopower:0 };
  data.staff.filter(s=>(s.status||'active')==='active').forEach(s => totals[s.entity] = (totals[s.entity]||0) + Number(s.salary));
  const totalAll = Object.values(totals).reduce((a,b)=>a+b,0);
  
  document.getElementById('payrollStats').innerHTML = `
    <div class="stat-card" style="border-top:3px solid var(--martinas);"><div class="label">Martinas Payroll</div><div class="value" style="font-size:16px">${fmtN(totals.martinas)}</div><div class="sub">${data.staff.filter(s=>s.entity==='martinas'&&(s.status||'active')==='active').length} staff</div></div>
    <div class="stat-card" style="border-top:3px solid var(--tetteh);"><div class="label">Tetteh Osei Payroll</div><div class="value" style="font-size:16px">${fmtN(totals.tetteh)}</div><div class="sub">${data.staff.filter(s=>s.entity==='tetteh'&&(s.status||'active')==='active').length} staff</div></div>
    <div class="stat-card" style="border-top:3px solid var(--ecopower);"><div class="label">Eco-Power Payroll</div><div class="value" style="font-size:16px">${fmtN(totals.ecopower)}</div><div class="sub">${data.staff.filter(s=>s.entity==='ecopower'&&(s.status||'active')==='active').length} staff</div></div>
    <div class="stat-card accent"><div class="label">Total Monthly Payroll</div><div class="value" style="font-size:16px">${fmtN(totalAll)}</div><div class="sub">All entities combined</div></div>
  `;
  
  const total = staff.filter(s=>(s.status||'active')==='active').reduce((s,st)=>s+Number(st.salary),0);
  document.getElementById('payrollBody').innerHTML = staff.map((s,i) => `
    <tr>
      <td>${i+1}</td>
      <td><strong>${s.name}</strong><br><small class="text-muted">${s.role||''}</small></td>
      <td>${entityBadge(s.entity)}</td>
      <td>${s.branch||'‚Äî'}</td>
      <td>${s.phone||'‚Äî'}</td>
      <td>${s.bank||'‚Äî'}</td>
      <td class="mono" style="font-size:12px">${s.accountNo||'‚Äî'}</td>
      <td class="text-right mono"><strong>${fmtN(s.salary)}</strong></td>
      <td><span class="badge ${(s.status||'active')==='active'?'badge-success':'badge-danger'}">${s.status||'active'}</span></td>
      <td>
        <button class="btn btn-outline btn-sm" onclick="toggleStaffStatus('${s.id}')">${(s.status||'active')==='active'?'Deactivate':'Activate'}</button>
        <button class="btn btn-red btn-sm" onclick="deleteRecord('staff','${s.id}')">üóë</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="10" class="text-center text-muted" style="padding:24px">No staff found</td></tr>';
  
  document.getElementById('payrollTotalRow').innerHTML = `Total Monthly Payroll (filtered): GHS ${fmtN(total)}`;
}

function saveStaff() {
  const entity = document.getElementById('staff_entity').value;
  const name = document.getElementById('staff_name').value;
  const role = document.getElementById('staff_role').value;
  const branch = document.getElementById('staff_branch').value;
  const phone = document.getElementById('staff_phone').value;
  const bank = document.getElementById('staff_bank').value;
  const accountNo = document.getElementById('staff_acct').value;
  const salary = document.getElementById('staff_salary').value;
  const startDate = document.getElementById('staff_startdate').value;
  const ssnit = document.getElementById('staff_ssnit').value;
  const tin = document.getElementById('staff_tin').value;
  
  if (!name || !salary) { notify('Name and salary are required', 'danger'); return; }
  
  const data = db();
  data.staff.push({ id: uid(), entity, name, role, branch, phone, bank, accountNo, salary: Number(salary), startDate, ssnit, tin, status: 'active', createdBy: currentUser.name, createdAt: new Date().toISOString() });
  dbSave(data);
  addAudit('Payroll', entityLabel(entity), `${name} added to payroll ‚Äî GHS ${salary}/mo`);
  closeModal('staffModal');
  ['staff_name','staff_role','staff_branch','staff_phone','staff_bank','staff_acct','staff_salary','staff_ssnit','staff_tin'].forEach(id => document.getElementById(id).value = '');
  renderPayroll();
  notify('Staff added to payroll!');
}

function toggleStaffStatus(id) {
  const data = db();
  const s = data.staff.find(s => s.id === id);
  if (s) { s.status = (s.status||'active') === 'active' ? 'inactive' : 'active'; dbSave(data); renderPayroll(); notify('Status updated'); }
}

function generatePayslips() {
  const data = db();
  const activeStaff = data.staff.filter(s => (s.status||'active') === 'active');
  if (activeStaff.length === 0) { notify('No active staff', 'warning'); return; }
  
  const month = new Date().toLocaleDateString('en-GH', {month:'long',year:'numeric'});
  const win = window.open('', '_blank');
  win.document.write(`<html><head><title>Payslips ‚Äî ${month}</title><style>
    body{font-family:sans-serif;padding:20px} .payslip{border:1px solid #ccc;padding:20px;margin:20px 0;border-radius:8px;page-break-after:always}
    h2{color:#1a3a2a} table{width:100%;border-collapse:collapse;margin-top:10px} td,th{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .total{font-weight:700;font-size:18px;color:#1a3a2a}
  </style></head><body>`);
  activeStaff.forEach(s => {
    const paye = Number(s.salary) > 4380 ? (Number(s.salary) - 4380) * 0.25 : 0; // simplified PAYE
    const ssnit = Number(s.salary) * 0.055;
    const net = Number(s.salary) - paye - ssnit;
    win.document.write(`<div class="payslip">
      <h2>MARTINAS COMPANY LIMITED ‚Äî Payslip</h2>
      <p><strong>Period:</strong> ${month} &nbsp;&nbsp; <strong>Entity:</strong> ${entityLabel(s.entity)}</p>
      <hr>
      <p><strong>Employee:</strong> ${s.name}</p>
      <p><strong>Role:</strong> ${s.role||'N/A'} &nbsp;&nbsp; <strong>Branch:</strong> ${s.branch||'N/A'}</p>
      <p><strong>Bank:</strong> ${s.bank||'N/A'} &nbsp;&nbsp; <strong>Account:</strong> ${s.accountNo||'N/A'}</p>
      <table>
        <tr><th>Description</th><th>Amount (GHS)</th></tr>
        <tr><td>Gross Salary</td><td>${fmtN(s.salary)}</td></tr>
        <tr><td>SSNIT Deduction (5.5%)</td><td style="color:red">- ${fmtN(ssnit)}</td></tr>
        <tr><td>PAYE Tax (estimate)</td><td style="color:red">- ${fmtN(paye)}</td></tr>
        <tr><td class="total">NET PAY</td><td class="total">${fmtN(net)}</td></tr>
      </table>
      <p style="margin-top:20px;font-size:12px;color:#888">Generated on ${new Date().toLocaleDateString()} by ${currentUser.name}</p>
    </div>`);
  });
  win.document.write('</body></html>');
  win.print();
}

// ============================================================
// ECO-POWER
// ============================================================
function populateEcoProductDropdown() {
  const data = db();
  const sel = document.getElementById('ecosale_product');
  sel.innerHTML = '<option value="">-- Select Product --</option>' + data.ecoProducts.map(p => `<option value="${p.id}">${p.name} (${p.stock} in stock)</option>`).join('');
}

function autoSetEcoPrice() {
  const data = db();
  const custType = document.getElementById('ecosale_custtype').value;
  const productId = document.getElementById('ecosale_product').value;
  const product = data.ecoProducts.find(p => p.id === productId);
  if (!product) return;
  const prices = { individual: product.retailPrice, corporate: product.wholesalePrice, dealer: product.dealerPrice };
  document.getElementById('ecosale_price').value = prices[custType] || 0;
  calcEcoTotal();
}

function calcEcoTotal() {
  const qty = parseFloat(document.getElementById('ecosale_qty').value) || 0;
  const price = parseFloat(document.getElementById('ecosale_price').value) || 0;
  document.getElementById('ecosale_total').value = (qty * price).toFixed(2);
}

function toggleCreditFields() {
  const type = document.getElementById('ecosale_paytype').value;
  document.getElementById('creditFields').style.display = (type === 'credit' || type === 'partial') ? 'block' : 'none';
}

function renderEcoAll() {
  renderEcoInventory();
  renderEcoSales();
  renderEcoStats();
  renderEcoDebtors();
  populateEcoProductDropdown();
}

function renderEcoStats() {
  const data = db();
  const sales = data.ecoSales;
  const totalSales = sales.reduce((s,r) => s+Number(r.total),0);
  const totalCash = sales.filter(r=>r.payType==='cash').reduce((s,r)=>s+Number(r.total),0);
  const totalCredit = sales.filter(r=>r.payType==='credit'||r.payType==='partial').reduce((s,r)=>s+Number(r.balance||0),0);
  const totalStock = data.ecoProducts.reduce((s,p)=>s+Number(p.stock),0);
  
  document.getElementById('ecoStats').innerHTML = `
    <div class="stat-card orange"><div class="label">Total Sales Revenue</div><div class="value" style="font-size:18px">${fmtN(totalSales)}</div><div class="sub">${sales.length} transactions</div></div>
    <div class="stat-card green"><div class="label">Cash Sales</div><div class="value" style="font-size:18px">${fmtN(totalCash)}</div></div>
    <div class="stat-card red"><div class="label">Outstanding Credit</div><div class="value" style="font-size:18px">${fmtN(totalCredit)}</div></div>
    <div class="stat-card blue"><div class="label">Total Stock Units</div><div class="value" style="font-size:18px">${totalStock}</div><div class="sub">${data.ecoProducts.length} product types</div></div>
  `;
}

function renderEcoInventory() {
  const data = db();
  document.getElementById('ecoInventory').innerHTML = data.ecoProducts.map(p => {
    const isLow = Number(p.stock) <= Number(p.reorder);
    return `<tr>
      <td><strong>${p.name}</strong></td>
      <td>${p.unit}</td>
      <td class="mono ${isLow?'text-danger':'text-success'}">${p.stock}</td>
      <td class="mono">${fmtN(p.retailPrice)}</td>
      <td class="mono">${fmtN(p.wholesalePrice)}</td>
      <td class="mono">${fmtN(p.dealerPrice)}</td>
      <td class="mono">${p.reorder}</td>
      <td><span class="badge ${isLow?'badge-danger':'badge-success'}">${isLow?'Low Stock':'OK'}</span></td>
    </tr>`;
  }).join('') || '<tr><td colspan="8" class="text-center text-muted" style="padding:24px">No products. Add stock first.</td></tr>';
}

function renderEcoDebtors() {
  const data = db();
  const debtors = data.ecoSales.filter(s => (s.payType === 'credit' || s.payType === 'partial') && Number(s.balance||0) > 0);
  if (debtors.length === 0) {
    document.getElementById('ecoDebtors').innerHTML = '<p style="color:var(--text-muted);font-size:13px;padding:12px 0;">No outstanding credit sales</p>';
    return;
  }
  document.getElementById('ecoDebtors').innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>Customer</th><th>Date</th><th>Total</th><th>Balance Due</th><th>Due Date</th><th>Action</th></tr></thead>
    <tbody>${debtors.map(s => `<tr>
      <td><strong>${s.customer}</strong><br><small>${s.contact||''}</small></td>
      <td>${s.date}</td>
      <td class="mono">${fmtN(s.total)}</td>
      <td class="mono text-danger"><strong>${fmtN(s.balance)}</strong></td>
      <td class="${s.dueDate&&new Date(s.dueDate)<new Date()?'text-danger':''}">${s.dueDate||'‚Äî'}</td>
      <td><button class="btn btn-green btn-sm" onclick="markCreditPaid('${s.id}')">Mark Paid</button></td>
    </tr>`).join('')}</tbody>
  </table></div>`;
}

function renderEcoSales() {
  const data = db();
  const search = document.getElementById('ecoSearch').value.toLowerCase();
  const payF = document.getElementById('ecoPayFilter').value;
  const month = document.getElementById('ecoMonthFilter').value;
  
  let sales = data.ecoSales;
  if (search) sales = sales.filter(s => JSON.stringify(s).toLowerCase().includes(search));
  if (payF) sales = sales.filter(s => s.payType === payF);
  if (month) sales = sales.filter(s => s.date.startsWith(month));
  sales = [...sales].sort((a,b) => b.date.localeCompare(a.date));
  
  const total = sales.reduce((s,r)=>s+Number(r.total),0);
  document.getElementById('ecoSalesBody').innerHTML = sales.map(s => `
    <tr>
      <td>${s.date}</td>
      <td><strong>${s.customer}</strong></td>
      <td><span class="badge badge-info">${s.customerType}</span></td>
      <td>${s.productName||'‚Äî'}</td>
      <td class="mono">${s.qty}</td>
      <td class="mono">${fmtN(s.unitPrice)}</td>
      <td><span class="badge ${s.payType==='cash'?'badge-success':s.payType==='credit'?'badge-danger':'badge-warning'}">${s.payType}</span></td>
      <td class="mono">${fmtN(s.amountPaid)}</td>
      <td class="text-right mono"><strong>${fmtN(s.total)}</strong></td>
      <td><span class="badge ${Number(s.balance||0)>0?'badge-danger':'badge-success'}">${Number(s.balance||0)>0?'Owes '+fmtN(s.balance):'Cleared'}</span></td>
      <td><button class="btn btn-red btn-sm" onclick="deleteRecord('ecoSales','${s.id}')">üóë</button></td>
    </tr>
  `).join('') || '<tr><td colspan="11" class="text-center text-muted" style="padding:24px">No sales recorded</td></tr>';
  
  document.getElementById('ecoTotalRow').innerHTML = `Total Revenue (filtered): GHS ${fmtN(total)}`;
}

function saveEcoStock() {
  const name = document.getElementById('ecostock_name').value;
  const unit = document.getElementById('ecostock_unit').value;
  const qty = parseInt(document.getElementById('ecostock_qty').value) || 0;
  const cost = parseFloat(document.getElementById('ecostock_cost').value) || 0;
  const retailPrice = parseFloat(document.getElementById('ecostock_retail').value) || 0;
  const wholesalePrice = parseFloat(document.getElementById('ecostock_wholesale').value) || 0;
  const dealerPrice = parseFloat(document.getElementById('ecostock_dealer').value) || 0;
  const reorder = parseInt(document.getElementById('ecostock_reorder').value) || 10;
  
  if (!name) { notify('Product name required', 'danger'); return; }
  
  const data = db();
  const existing = data.ecoProducts.find(p => p.name.toLowerCase() === name.toLowerCase());
  if (existing) {
    existing.stock = Number(existing.stock) + qty;
    existing.cost = cost || existing.cost;
    existing.retailPrice = retailPrice || existing.retailPrice;
    existing.wholesalePrice = wholesalePrice || existing.wholesalePrice;
    existing.dealerPrice = dealerPrice || existing.dealerPrice;
    existing.reorder = reorder;
  } else {
    data.ecoProducts.push({ id: uid(), name, unit, stock: qty, cost, retailPrice, wholesalePrice, dealerPrice, reorder });
  }
  dbSave(data);
  addAudit('Eco-Power', 'Eco-Power', `Stock updated: ${name} +${qty} units`);
  closeModal('ecoStockModal');
  renderEcoAll();
  notify('Stock updated!');
}

function saveEcoSale() {
  const date = document.getElementById('ecosale_date').value;
  const customer = document.getElementById('ecosale_cust').value;
  const customerType = document.getElementById('ecosale_custtype').value;
  const productId = document.getElementById('ecosale_product').value;
  const qty = parseInt(document.getElementById('ecosale_qty').value);
  const unitPrice = parseFloat(document.getElementById('ecosale_price').value);
  const total = parseFloat(document.getElementById('ecosale_total').value);
  const payType = document.getElementById('ecosale_paytype').value;
  const amountPaid = parseFloat(document.getElementById('ecosale_paid').value) || (payType==='cash'?total:0);
  const dueDate = document.getElementById('ecosale_duedate').value;
  const contact = document.getElementById('ecosale_contact').value;
  const notes = document.getElementById('ecosale_notes').value;
  
  if (!date || !customer || !qty || !unitPrice) { notify('Please fill required fields', 'danger'); return; }
  
  const data = db();
  if (!productId) { notify('Select a product', 'danger'); return; }
  const product = data.ecoProducts.find(p => p.id === productId);
  if (!product) { notify('Product not found', 'danger'); return; }
  if (Number(product.stock) < qty) { notify(`Insufficient stock! Only ${product.stock} units available.`, 'danger'); return; }
  
  product.stock = Number(product.stock) - qty;
  const balance = Math.max(total - amountPaid, 0);
  
  data.ecoSales.push({ id: uid(), date, customer, customerType, productId, productName: product.name, qty, unitPrice, total, payType, amountPaid, balance, dueDate, contact, notes, createdBy: currentUser.name });
  dbSave(data);
  addAudit('Eco-Power Sale', 'Eco-Power', `${customer} ‚Äî ${qty} ${product.unit}(s) ‚Äî GHS ${total}`);
  closeModal('ecoSaleModal');
  renderEcoAll();
  notify('Sale recorded!');
}

function markCreditPaid(id) {
  const data = db();
  const sale = data.ecoSales.find(s => s.id === id);
  if (sale) { sale.amountPaid = sale.total; sale.balance = 0; sale.payType = 'cash'; dbSave(data); renderEcoAll(); notify('Marked as paid!'); }
}

// ============================================================
// CLEANERS
// ============================================================
function renderCleaners() {
  const data = db();
  const search = document.getElementById('cleanerSearch').value.toLowerCase();
  let cleaners = data.cleaners;
  if (search) cleaners = cleaners.filter(c => JSON.stringify(c).toLowerCase().includes(search));
  
  const active = data.cleaners.filter(c=>c.status!=='inactive');
  const totalPay = active.reduce((s,c)=>s+Number(c.pay||0),0);
  document.getElementById('cleanerStats').innerHTML = `
    <div class="stat-card" style="border-top:3px solid var(--tetteh);"><div class="label">Total Cleaners</div><div class="value">${data.cleaners.length}</div></div>
    <div class="stat-card green"><div class="label">Active</div><div class="value">${active.length}</div></div>
    <div class="stat-card red"><div class="label">Inactive</div><div class="value">${data.cleaners.filter(c=>c.status==='inactive').length}</div></div>
    <div class="stat-card purple"><div class="label">Monthly Payroll</div><div class="value" style="font-size:16px">${fmtN(totalPay)}</div></div>
  `;
  
  document.getElementById('cleanersBody').innerHTML = cleaners.map(c => `
    <tr>
      <td><strong>${c.name}</strong></td>
      <td>${c.establishment||'‚Äî'}</td>
      <td>${c.phone||'‚Äî'}</td>
      <td>${c.startDate||'‚Äî'}</td>
      <td class="mono">${fmtN(c.pay)}</td>
      <td><span class="badge ${(c.status||'active')==='active'?'badge-success':'badge-danger'}">${c.status||'active'}</span></td>
      <td>
        <button class="btn btn-outline btn-sm" onclick="toggleCleanerStatus('${c.id}')">${(c.status||'active')==='active'?'Deactivate':'Activate'}</button>
        <button class="btn btn-red btn-sm" onclick="deleteCleaner('${c.id}')">üóë</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="7" class="text-center text-muted" style="padding:24px">No cleaners added</td></tr>';
}

function renderContracts() {
  const data = db();
  document.getElementById('contractsBody').innerHTML = data.contracts.map(c => `
    <tr>
      <td><strong>${c.client}</strong></td>
      <td>${c.location||'‚Äî'}</td>
      <td>${c.cleanerCount||'‚Äî'}</td>
      <td class="mono">${fmtN(c.value)}</td>
      <td><span class="badge ${c.status==='active'?'badge-success':'badge-warning'}">${c.status||'active'}</span></td>
      <td>
        <button class="btn btn-red btn-sm" onclick="deleteRecord('contracts','${c.id}')">üóë</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="6" class="text-center text-muted" style="padding:24px">No contracts</td></tr>';
}

function saveCleaner() {
  const name = document.getElementById('cleaner_name').value;
  const phone = document.getElementById('cleaner_phone').value;
  const establishment = document.getElementById('cleaner_estab').value;
  const location = document.getElementById('cleaner_loc').value;
  const pay = parseFloat(document.getElementById('cleaner_pay').value) || 0;
  const startDate = document.getElementById('cleaner_start').value;
  const bank = document.getElementById('cleaner_bank').value;
  const accountNo = document.getElementById('cleaner_acct').value;
  
  if (!name) { notify('Cleaner name required', 'danger'); return; }
  
  const data = db();
  data.cleaners.push({ id: uid(), name, phone, establishment, location, pay, startDate, bank, accountNo, status: 'active', createdBy: currentUser.name });
  dbSave(data);
  addAudit('Cleaner Added', 'Tetteh Osei', `${name} ‚Äî ${establishment||'Not assigned'}`);
  closeModal('cleanerModal');
  ['cleaner_name','cleaner_phone','cleaner_estab','cleaner_loc','cleaner_pay','cleaner_bank','cleaner_acct'].forEach(id => document.getElementById(id).value='');
  renderCleaners();
  notify('Cleaner added!');
}

function toggleCleanerStatus(id) {
  const data = db();
  const c = data.cleaners.find(c => c.id === id);
  if (c) { c.status = (c.status||'active')==='active'?'inactive':'active'; dbSave(data); renderCleaners(); notify('Status updated'); }
}

function deleteCleaner(id) {
  if (!confirm('Remove this cleaner?')) return;
  const data = db();
  data.cleaners = data.cleaners.filter(c => c.id !== id);
  dbSave(data);
  renderCleaners();
  notify('Cleaner removed', 'warning');
}

function saveContract() {
  const client = document.getElementById('contract_client').value;
  const location = document.getElementById('contract_loc').value;
  const cleanerCount = document.getElementById('contract_cleaners').value;
  const value = parseFloat(document.getElementById('contract_value').value) || 0;
  const startDate = document.getElementById('contract_start').value;
  const endDate = document.getElementById('contract_end').value;
  const notes = document.getElementById('contract_notes').value;
  
  if (!client) { notify('Client name required', 'danger'); return; }
  const data = db();
  data.contracts.push({ id: uid(), client, location, cleanerCount, value, startDate, endDate, notes, status: 'active', createdBy: currentUser.name });
  dbSave(data);
  addAudit('Contract Added', 'Tetteh Osei', `${client} ‚Äî GHS ${value}/mo`);
  closeModal('contractModal');
  renderContracts();
  notify('Contract saved!');
}

// ============================================================
// DOCUMENTS
// ============================================================
function filterDocsEntity(entity, el) {
  currentDocsEntity = entity;
  document.querySelectorAll('#sec-receipts .entity-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderDocs();
}

function previewUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const preview = document.getElementById('upload_preview');
  if (file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = e => preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:200px;border-radius:8px;">`;
    reader.readAsDataURL(file);
  } else {
    preview.innerHTML = `<p style="color:var(--success)">‚úÖ ${file.name} selected</p>`;
  }
}

async function saveDoc() {
  const entity = document.getElementById('upload_entity').value;
  const type = document.getElementById('upload_type').value;
  const desc = document.getElementById('upload_desc').value;
  const date = document.getElementById('upload_date').value;
  const file = document.getElementById('upload_file').files[0];
  
  if (!file) { notify('Please select a file', 'danger'); return; }
  
  const base64 = await fileToBase64(file);
  const data = db();
  data.docs.push({ id: uid(), entity, type, description: desc, date, filename: file.name, fileType: file.type, data: base64, createdBy: currentUser.name, createdAt: new Date().toISOString() });
  dbSave(data);
  addAudit('Document Upload', entityLabel(entity), `${type}: ${desc||file.name}`);
  closeModal('uploadModal');
  document.getElementById('upload_file').value = '';
  document.getElementById('upload_preview').innerHTML = '';
  document.getElementById('upload_desc').value = '';
  renderDocs();
  notify('Document uploaded!');
}

function renderDocs() {
  const data = db();
  const search = document.getElementById('docsSearch').value.toLowerCase();
  const typeF = document.getElementById('docsTypeFilter').value;
  
  let docs = data.docs;
  if (currentDocsEntity !== 'all') docs = docs.filter(d => d.entity === currentDocsEntity);
  if (search) docs = docs.filter(d => JSON.stringify(d).toLowerCase().includes(search));
  if (typeF) docs = docs.filter(d => d.type === typeF);
  docs = [...docs].sort((a,b) => b.createdAt.localeCompare(a.createdAt));
  
  document.getElementById('docsGrid').innerHTML = docs.map(d => {
    const isImg = d.fileType && d.fileType.startsWith('image/');
    const icon = { receipt: 'üßæ', invoice: 'üìã', other: 'üìÑ' }[d.type] || 'üìÑ';
    return `<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:16px;cursor:pointer;" onclick="viewImg('${isImg ? d.data : ''}')">
      ${isImg ? `<img src="${d.data}" style="width:100%;height:120px;object-fit:cover;border-radius:6px;margin-bottom:10px;">` : `<div style="height:120px;background:#f0ede8;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:40px;margin-bottom:10px;">${icon}</div>`}
      <div class="badge badge-${d.entity==='martinas'?'martinas':d.entity==='tetteh'?'tetteh':'ecopower'}" style="margin-bottom:6px;">${entityLabel(d.entity)}</div>
      <div style="font-weight:600;font-size:13px;">${d.description||d.filename}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${d.type} ‚Ä¢ ${d.date}</div>
      <button class="btn btn-red btn-sm" style="margin-top:8px;width:100%;" onclick="event.stopPropagation();deleteRecord('docs','${d.id}')">Delete</button>
    </div>`;
  }).join('') || '<div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:40px">No documents uploaded</div>';
}

function viewImg(src) {
  if (!src) return;
  document.getElementById('viewerImg').src = src;
  openModal('imgViewer');
}

// ============================================================
// REPORTS
// ============================================================
function quickReport(type, entity) {
  document.getElementById('reportType').value = type;
  document.getElementById('reportEntity').value = entity;
  const now = new Date();
  document.getElementById('reportFrom').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
  document.getElementById('reportTo').value = now.toISOString().slice(0,10);
  generateReport();
}

function generateReport() {
  const data = db();
  const entity = document.getElementById('reportEntity').value;
  const type = document.getElementById('reportType').value;
  const from = document.getElementById('reportFrom').value;
  const to = document.getElementById('reportTo').value;
  
  const entityName = { all: 'Consolidated ‚Äî All Entities', martinas: 'Martinas Company Limited', tetteh: 'Tetteh Osei Cleaning Services', ecopower: 'Eco-Power Department' }[entity];
  const periodText = `Period: ${from || 'All time'} to ${to || 'Present'}`;
  
  const filterByDate = arr => arr.filter(r => {
    const d = r.date || r.createdAt?.slice(0,10);
    if (from && d < from) return false;
    if (to && d > to) return false;
    return true;
  });
  
  const filterByEntity = arr => entity === 'all' ? arr : arr.filter(r => r.entity === entity);
  
  const income = filterByEntity(filterByDate(data.income));
  const expenses = filterByEntity(filterByDate(data.expenditure));
  const totalIncome = income.reduce((s,r)=>s+Number(r.amount),0);
  const totalExpenses = expenses.reduce((s,r)=>s+Number(r.amount),0);
  const profit = totalIncome - totalExpenses;
  
  let html = `<div class="card" id="reportCard">
    <div class="report-header">
      <h2>MARTINAS COMPANY LIMITED</h2>
      <p>${entityName}</p>
      <p>${periodText}</p>
      <p style="font-size:12px;color:var(--text-light)">Generated on ${new Date().toLocaleDateString()} by ${currentUser.name}</p>
    </div>`;
  
  if (type === 'income_statement') {
    // Group income by category
    const incCats = {};
    income.forEach(r => { incCats[r.category] = (incCats[r.category]||0) + Number(r.amount); });
    const expCats = {};
    expenses.forEach(r => { expCats[r.category] = (expCats[r.category]||0) + Number(r.amount); });
    
    html += `<div class="report-section"><h3>INCOME / REVENUE</h3>
      <table><thead><tr><th>Category</th><th class="text-right">Amount (GHS)</th></tr></thead><tbody>
      ${Object.entries(incCats).map(([k,v]) => `<tr><td>${k}</td><td class="text-right mono">${fmtN(v)}</td></tr>`).join('')}
      <tr style="font-weight:700;border-top:2px solid var(--border)"><td>TOTAL INCOME</td><td class="text-right mono">${fmtN(totalIncome)}</td></tr>
      </tbody></table></div>
      <div class="report-section"><h3>EXPENSES</h3>
      <table><thead><tr><th>Category</th><th class="text-right">Amount (GHS)</th></tr></thead><tbody>
      ${Object.entries(expCats).map(([k,v]) => `<tr><td>${k}</td><td class="text-right mono">${fmtN(v)}</td></tr>`).join('')}
      <tr style="font-weight:700;border-top:2px solid var(--border)"><td>TOTAL EXPENSES</td><td class="text-right mono">${fmtN(totalExpenses)}</td></tr>
      </tbody></table></div>
      <div style="background:${profit>=0?'var(--success-light)':'var(--danger-light)'};padding:20px;border-radius:var(--radius);text-align:center;margin-top:16px;">
        <div style="font-size:13px;font-weight:600;color:var(--text-muted)">NET ${profit>=0?'PROFIT':'LOSS'}</div>
        <div style="font-size:32px;font-weight:700;font-family:'DM Mono',monospace;color:${profit>=0?'var(--success)':'var(--danger)'}">GHS ${fmtN(Math.abs(profit))}</div>
      </div>`;
  }
  
  else if (type === 'cashflow') {
    const cashIn = income;
    const cashOut = expenses;
    html += `<div class="report-section"><h3>OPERATING ACTIVITIES ‚Äî CASH INFLOWS</h3>
      <table><thead><tr><th>Date</th><th>Description</th><th>Entity</th><th class="text-right">Amount (GHS)</th></tr></thead><tbody>
      ${cashIn.map(r=>`<tr><td>${r.date}</td><td>${r.description}</td><td>${entityLabel(r.entity)}</td><td class="text-right mono text-success">${fmtN(r.amount)}</td></tr>`).join('')}
      <tr style="font-weight:700;"><td colspan="3">Total Cash Inflows</td><td class="text-right mono">${fmtN(totalIncome)}</td></tr>
      </tbody></table></div>
      <div class="report-section"><h3>OPERATING ACTIVITIES ‚Äî CASH OUTFLOWS</h3>
      <table><thead><tr><th>Date</th><th>Description</th><th>Entity</th><th class="text-right">Amount (GHS)</th></tr></thead><tbody>
      ${cashOut.map(r=>`<tr><td>${r.date}</td><td>${r.description}</td><td>${entityLabel(r.entity)}</td><td class="text-right mono text-danger">${fmtN(r.amount)}</td></tr>`).join('')}
      <tr style="font-weight:700;"><td colspan="3">Total Cash Outflows</td><td class="text-right mono">${fmtN(totalExpenses)}</td></tr>
      </tbody></table></div>
      <div style="background:var(--info-light);padding:16px;border-radius:var(--radius);margin-top:16px;">
        <strong>Net Cash Position: GHS ${fmtN(profit)}</strong>
      </div>`;
  }
  
  else if (type === 'balance_sheet') {
    const assets = entity === 'all' ? data.assets : data.assets.filter(a=>a.entity===entity);
    const liabs = entity === 'all' ? data.liabilities : data.liabilities.filter(l=>l.entity===entity);
    const totalAssets = assets.reduce((s,a) => {
      const depYrs = (new Date() - new Date(a.purchaseDate||new Date())) / (365.25*24*60*60*1000);
      const dep = ((Number(a.cost) - Number(a.salvage||0)) / Number(a.usefulLife||1)) * depYrs;
      return s + Math.max(Number(a.cost) - dep, Number(a.salvage||0));
    }, 0) + totalIncome - totalExpenses;
    const totalLiab = liabs.reduce((s,l)=>s+Number(l.amount),0);
    
    html += `<div class="report-section"><h3>ASSETS</h3>
      <table><thead><tr><th>Asset</th><th>Entity</th><th class="text-right">Net Value (GHS)</th></tr></thead><tbody>
      ${assets.map(a => {
        const depYrs = (new Date() - new Date(a.purchaseDate||new Date())) / (365.25*24*60*60*1000);
        const dep = ((Number(a.cost)-Number(a.salvage||0))/Number(a.usefulLife||1))*depYrs;
        const net = Math.max(Number(a.cost)-dep,Number(a.salvage||0));
        return `<tr><td>${a.name}</td><td>${entityLabel(a.entity)}</td><td class="text-right mono">${fmtN(net)}</td></tr>`;
      }).join('')}
      <tr><td>Cash & Equivalents (Net)</td><td>${entityName}</td><td class="text-right mono">${fmtN(profit)}</td></tr>
      <tr style="font-weight:700;border-top:2px solid var(--border);"><td colspan="2">TOTAL ASSETS</td><td class="text-right mono">${fmtN(totalAssets)}</td></tr>
      </tbody></table></div>
      <div class="report-section"><h3>LIABILITIES</h3>
      <table><thead><tr><th>Description</th><th>Entity</th><th class="text-right">Amount (GHS)</th></tr></thead><tbody>
      ${liabs.map(l=>`<tr><td>${l.description}</td><td>${entityLabel(l.entity)}</td><td class="text-right mono">${fmtN(l.amount)}</td></tr>`).join('')}
      <tr style="font-weight:700;border-top:2px solid var(--border);"><td colspan="2">TOTAL LIABILITIES</td><td class="text-right mono">${fmtN(totalLiab)}</td></tr>
      </tbody></table></div>
      <div class="report-section"><h3>EQUITY</h3>
      <table><tbody>
      <tr style="font-weight:700;font-size:16px;"><td>NET EQUITY (Assets - Liabilities)</td><td class="text-right mono" style="color:${totalAssets-totalLiab>=0?'var(--success)':'var(--danger)'}">GHS ${fmtN(totalAssets-totalLiab)}</td></tr>
      </tbody></table></div>`;
  }
  
  else if (type === 'expense_report') {
    const byCat = {};
    expenses.forEach(r => { if(!byCat[r.category]) byCat[r.category]=[]; byCat[r.category].push(r); });
    html += `<div class="report-section"><h3>EXPENSE BREAKDOWN BY CATEGORY</h3>`;
    Object.entries(byCat).forEach(([cat,recs]) => {
      const catTotal = recs.reduce((s,r)=>s+Number(r.amount),0);
      html += `<div style="margin-bottom:16px;"><div style="font-weight:600;margin-bottom:6px;">${cat} ‚Äî GHS ${fmtN(catTotal)}</div>
        <table><thead><tr><th>Date</th><th>Entity</th><th>Description</th><th>Vendor</th><th class="text-right">Amount</th></tr></thead><tbody>
        ${recs.map(r=>`<tr><td>${r.date}</td><td>${entityLabel(r.entity)}</td><td>${r.description}</td><td>${r.vendor||'‚Äî'}</td><td class="text-right mono">${fmtN(r.amount)}</td></tr>`).join('')}
        </tbody></table></div>`;
    });
    html += `<div style="font-weight:700;font-size:16px;text-align:right;padding:12px 0;border-top:2px solid var(--border);">TOTAL EXPENSES: GHS ${fmtN(totalExpenses)}</div></div>`;
  }
  
  else if (type === 'payroll_summary') {
    const entities = ['martinas','tetteh','ecopower'];
    entities.forEach(e => {
      const staff = data.staff.filter(s=>s.entity===e);
      const cleaners = e==='tetteh' ? data.cleaners : [];
      const total = [...staff,...cleaners].reduce((s,r)=>s+Number(r.salary||r.pay||0),0);
      html += `<div class="report-section"><h3>${entityLabel(e)} ‚Äî Payroll</h3>
        <table><thead><tr><th>#</th><th>Name</th><th>Branch</th><th>Bank</th><th>Account No.</th><th class="text-right">Salary (GHS)</th></tr></thead><tbody>
        ${staff.map((s,i)=>`<tr><td>${i+1}</td><td>${s.name}</td><td>${s.branch||'‚Äî'}</td><td>${s.bank||'‚Äî'}</td><td class="mono">${s.accountNo||'‚Äî'}</td><td class="text-right mono">${fmtN(s.salary)}</td></tr>`).join('')}
        ${e==='tetteh'?cleaners.map((c,i)=>`<tr><td>${staff.length+i+1}</td><td>${c.name} <small>(Cleaner)</small></td><td>${c.location||'‚Äî'}</td><td>${c.bank||'‚Äî'}</td><td class="mono">${c.accountNo||'‚Äî'}</td><td class="text-right mono">${fmtN(c.pay)}</td></tr>`).join(''):''}
        <tr style="font-weight:700;border-top:2px solid var(--border);"><td colspan="5">SUBTOTAL</td><td class="text-right mono">${fmtN(total)}</td></tr>
        </tbody></table></div>`;
    });
    const grandTotal = data.staff.reduce((s,r)=>s+Number(r.salary||0),0) + data.cleaners.reduce((s,c)=>s+Number(c.pay||0),0);
    html += `<div style="font-weight:700;font-size:18px;text-align:right;padding:16px;background:var(--success-light);border-radius:var(--radius);">GRAND TOTAL PAYROLL: GHS ${fmtN(grandTotal)}</div>`;
  }
  
  else if (type === 'ecopower_report') {
    const sales = filterByDate(data.ecoSales);
    const totalSales = sales.reduce((s,r)=>s+Number(r.total),0);
    const cashSales = sales.filter(r=>r.payType==='cash').reduce((s,r)=>s+Number(r.total),0);
    const creditOwed = sales.filter(r=>Number(r.balance||0)>0).reduce((s,r)=>s+Number(r.balance),0);
    html += `<div class="report-section"><h3>ECO-POWER SALES SUMMARY</h3>
      <table><tbody>
        <tr><td>Total Sales Revenue</td><td class="text-right mono"><strong>${fmtN(totalSales)}</strong></td></tr>
        <tr><td>Cash Collected</td><td class="text-right mono text-success">${fmtN(cashSales)}</td></tr>
        <tr><td>Outstanding Credit</td><td class="text-right mono text-danger">${fmtN(creditOwed)}</td></tr>
        <tr><td>Number of Transactions</td><td class="text-right mono">${sales.length}</td></tr>
      </tbody></table></div>
      <div class="report-section"><h3>INVENTORY POSITION</h3>
      <table><thead><tr><th>Product</th><th>Unit</th><th>Stock</th><th>Retail Price</th><th>Wholesale</th><th>Dealer</th></tr></thead><tbody>
      ${data.ecoProducts.map(p=>`<tr><td>${p.name}</td><td>${p.unit}</td><td class="${Number(p.stock)<=Number(p.reorder)?'text-danger':''}">${p.stock}</td><td class="mono">${fmtN(p.retailPrice)}</td><td class="mono">${fmtN(p.wholesalePrice)}</td><td class="mono">${fmtN(p.dealerPrice)}</td></tr>`).join('')}
      </tbody></table></div>
      <div class="report-section"><h3>DETAILED TRANSACTIONS</h3>
      <table><thead><tr><th>Date</th><th>Customer</th><th>Type</th><th>Product</th><th>Qty</th><th>Payment</th><th class="text-right">Total</th></tr></thead><tbody>
      ${sales.map(s=>`<tr><td>${s.date}</td><td>${s.customer}</td><td>${s.customerType}</td><td>${s.productName}</td><td>${s.qty}</td><td>${s.payType}</td><td class="text-right mono">${fmtN(s.total)}</td></tr>`).join('')}
      </tbody></table></div>`;
  }
  
  else if (type === 'trial_balance') {
    html += `<div class="report-section"><h3>TRIAL BALANCE</h3>
      <table><thead><tr><th>Account</th><th class="text-right">Debit (GHS)</th><th class="text-right">Credit (GHS)</th></tr></thead><tbody>`;
    const incCats = {};
    income.forEach(r => incCats[r.category] = (incCats[r.category]||0) + Number(r.amount));
    const expCats = {};
    expenses.forEach(r => expCats[r.category] = (expCats[r.category]||0) + Number(r.amount));
    Object.entries(expCats).forEach(([k,v]) => html += `<tr><td>${k}</td><td class="text-right mono">${fmtN(v)}</td><td class="text-right">‚Äî</td></tr>`);
    Object.entries(incCats).forEach(([k,v]) => html += `<tr><td>${k}</td><td class="text-right">‚Äî</td><td class="text-right mono">${fmtN(v)}</td></tr>`);
    html += `<tr style="font-weight:700;border-top:2px solid var(--border);">
      <td>TOTALS</td>
      <td class="text-right mono">${fmtN(totalExpenses)}</td>
      <td class="text-right mono">${fmtN(totalIncome)}</td>
    </tr></tbody></table></div>`;
  }
  
  html += `</div>`;
  document.getElementById('reportOutput').innerHTML = html;
}

// ============================================================
// USER MANAGEMENT
// ============================================================
function renderUsers() {
  const data = db();
  document.getElementById('usersBody').innerHTML = data.users.map(u => `
    <tr>
      <td><strong>${u.name}</strong></td>
      <td>${u.email}</td>
      <td><span class="badge ${u.role==='owner'?'badge-danger':u.role==='manager'?'badge-info':'badge-success'}">${u.role}</span></td>
      <td>${u.role === 'owner' ? 'Full Access' : u.role === 'manager' ? 'Read/Write' : 'Limited'}</td>
      <td>${(u.entities||[]).map(e=>entityBadge(e)).join(' ')}</td>
      <td><span class="badge ${u.active!==false?'badge-success':'badge-danger'}">${u.active!==false?'Active':'Inactive'}</span></td>
      <td>${u.role!=='owner'?`<button class="btn btn-outline btn-sm" onclick="toggleUser('${u.id}')">${u.active!==false?'Disable':'Enable'}</button>
      <button class="btn btn-red btn-sm" onclick="deleteUser('${u.id}')">üóë</button>`:'<em class="text-muted" style="font-size:12px">Owner Account</em>'}</td>
    </tr>
  `).join('');
}

function saveUser() {
  const name = document.getElementById('user_name').value;
  const email = document.getElementById('user_email').value;
  const pass = document.getElementById('user_pass').value;
  const role = document.getElementById('user_role').value;
  const entities = [];
  if (document.getElementById('ua_martinas').checked) entities.push('martinas');
  if (document.getElementById('ua_tetteh').checked) entities.push('tetteh');
  if (document.getElementById('ua_ecopower').checked) entities.push('ecopower');
  
  if (!name || !email || !pass) { notify('All fields required', 'danger'); return; }
  
  const data = db();
  if (data.users.find(u => u.email.toLowerCase() === email.toLowerCase())) { notify('Email already exists', 'danger'); return; }
  
  data.users.push({ id: uid(), name, email, password: btoa(pass), role, entities, active: true, created: new Date().toISOString() });
  dbSave(data);
  addAudit('User Created', 'System', `${name} (${role}) added by ${currentUser.name}`);
  closeModal('userModal');
  ['user_name','user_email','user_pass'].forEach(id => document.getElementById(id).value='');
  renderUsers();
  notify('User created!');
}

function toggleUser(id) {
  const data = db();
  const u = data.users.find(u => u.id === id);
  if (u) { u.active = u.active === false ? true : false; dbSave(data); renderUsers(); notify('User status updated'); }
}

function deleteUser(id) {
  if (!confirm('Delete this user? This cannot be undone.')) return;
  const data = db();
  data.users = data.users.filter(u => u.id !== id);
  dbSave(data);
  renderUsers();
  notify('User deleted', 'warning');
}

// ============================================================
// AUDIT LOG
// ============================================================
function renderAudit() {
  const data = db();
  const search = document.getElementById('auditSearch').value.toLowerCase();
  let log = data.auditLog;
  if (search) log = log.filter(a => JSON.stringify(a).toLowerCase().includes(search));
  
  document.getElementById('auditBody').innerHTML = log.map(a => `
    <tr>
      <td class="mono" style="font-size:12px;">${new Date(a.ts).toLocaleString()}</td>
      <td>${a.user}</td>
      <td><span class="badge badge-info">${a.action}</span></td>
      <td>${a.entity}</td>
      <td style="font-size:13px;">${a.details}</td>
    </tr>
  `).join('') || '<tr><td colspan="5" class="text-center text-muted" style="padding:24px">No audit records</td></tr>';
}

// ============================================================
// GENERIC DELETE
// ============================================================
function deleteRecord(collection, id) {
  if (!confirm('Delete this record? This cannot be undone.')) return;
  const data = db();
  data[collection] = data[collection].filter(r => r.id !== id);
  dbSave(data);
  addAudit('Delete', collection, `Record ${id} deleted`);
  // Refresh current view
  const sections = { income:'income', expenditure:'expenditure', assets:'assets', liabilities:'assets', staff:'payroll', ecoProducts:'ecopower', ecoSales:'ecopower', cleaners:'cleaning', contracts:'cleaning', docs:'receipts' };
  const sec = sections[collection] || collection;
  const fns = { income:renderIncome, expenditure:renderExp, assets:renderAssets, liabilities:renderAssets, payroll:renderPayroll, ecopower:renderEcoAll, cleaning:()=>{renderCleaners();renderContracts();}, receipts:renderDocs };
  if (fns[sec]) fns[sec]();
  notify('Record deleted', 'warning');
}

// ============================================================
// PRINT
// ============================================================
function printSection(name) { window.print(); }

// ============================================================
// BACKUP SECTION RENDER
// ============================================================
function renderBackup() {
  const data = db();
  const pettyCounts = Object.values(data.petty).reduce((t,e) => t + (e.entries||[]).length, 0);
  document.getElementById('backupStats').innerHTML = `
    <div class="stat-card accent"><div class="label">Income Records</div><div class="value">${data.income.length}</div><div class="sub">Transactions</div></div>
    <div class="stat-card red"><div class="label">Expense Records</div><div class="value">${data.expenditure.length}</div><div class="sub">Transactions</div></div>
    <div class="stat-card blue"><div class="label">Staff & Cleaners</div><div class="value">${data.staff.length + data.cleaners.length}</div><div class="sub">Payroll entries</div></div>
    <div class="stat-card green"><div class="label">Total Records</div><div class="value">${data.income.length + data.expenditure.length + data.staff.length + data.cleaners.length + data.ecoSales.length + data.assets.length + data.liabilities.length + pettyCounts}</div><div class="sub">Across all modules</div></div>
  `;
}

// ============================================================
// EXPORT TO EXCEL (.xlsx) ‚Äî using SheetJS
// ============================================================
function exportExcel(scope) {
  const data = db();
  const wb = XLSX.utils.book_new();
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-GH').replace(/\//g,'-');

  // ---- Helper: styled header row ----
  function makeSheet(headers, rows) {
    const wsData = [headers, ...rows];
    return XLSX.utils.aoa_to_sheet(wsData);
  }

  // ---- INCOME ----
  if (scope === 'all' || scope === 'finance') {
    const headers = ['Date','Entity','Category','Description','Reference','Received From','Amount (GHS)','Created By'];
    const rows = data.income.map(r => [r.date, entityLabel(r.entity), r.category, r.description, r.reference||'', r.from||'', Number(r.amount), r.createdBy||'']);
    // Add totals row
    if (rows.length > 0) {
      rows.push(['','','','','','TOTAL', `=SUM(G2:G${rows.length+1})`, '']);
    }
    const ws = makeSheet(headers, rows);
    // Column widths
    ws['!cols'] = [{wch:12},{wch:22},{wch:20},{wch:35},{wch:15},{wch:22},{wch:16},{wch:18}];
    XLSX.utils.book_append_sheet(wb, ws, 'Income');
  }

  // ---- EXPENDITURE ----
  if (scope === 'all' || scope === 'finance') {
    const headers = ['Date','Entity','Category','Description','Vendor','Payment Method','Amount (GHS)','Created By'];
    const rows = data.expenditure.map(r => [r.date, entityLabel(r.entity), r.category, r.description, r.vendor||'', r.method||'', Number(r.amount), r.createdBy||'']);
    if (rows.length > 0) rows.push(['','','','','','TOTAL', `=SUM(G2:G${rows.length+1})`, '']);
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:12},{wch:22},{wch:22},{wch:35},{wch:22},{wch:18},{wch:16},{wch:18}];
    XLSX.utils.book_append_sheet(wb, ws, 'Expenditure');
  }

  // ---- PETTY CASH ----
  if (scope === 'all' || scope === 'finance') {
    const headers = ['Entity','Date','Type','Description','Authorized By','Amount (GHS)','Running Balance'];
    const rows = [];
    ['martinas','tetteh','ecopower'].forEach(e => {
      const entries = (data.petty[e]?.entries || []).sort((a,b)=>a.date.localeCompare(b.date));
      let bal = 0;
      entries.forEach(r => {
        bal += r.type === 'income' ? Number(r.amount) : -Number(r.amount);
        rows.push([entityLabel(e), r.date, r.type==='income'?'IN':'OUT', r.description, r.authorizedBy||'', Number(r.amount), bal]);
      });
    });
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:20},{wch:12},{wch:8},{wch:35},{wch:20},{wch:16},{wch:18}];
    XLSX.utils.book_append_sheet(wb, ws, 'Petty Cash');
  }

  // ---- PAYROLL ‚Äî MARTINAS ----
  if (scope === 'all' || scope === 'payroll') {
    const headers = ['#','Full Name','Role','Branch / Location','Contact Number','Bank Name','Account Number','Gross Salary (GHS)','SSNIT No.','TIN','Start Date','Status'];
    const martStaff = data.staff.filter(s=>s.entity==='martinas');
    const rows = martStaff.map((s,i)=>[i+1,s.name,s.role||'',s.branch||'',s.phone||'',s.bank||'',s.accountNo||'',Number(s.salary),s.ssnit||'',s.tin||'',s.startDate||'',s.status||'active']);
    if (rows.length > 0) rows.push(['','','','','','','TOTAL MONTHLY',`=SUM(H2:H${rows.length+1})`,'','','','']);
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:4},{wch:25},{wch:20},{wch:20},{wch:16},{wch:16},{wch:20},{wch:18},{wch:16},{wch:14},{wch:12},{wch:10}];
    XLSX.utils.book_append_sheet(wb, ws, 'Payroll - Martinas');
  }

  // ---- PAYROLL ‚Äî ECO-POWER ----
  if (scope === 'all' || scope === 'payroll') {
    const headers = ['#','Full Name','Role','Branch / Location','Contact Number','Bank Name','Account Number','Gross Salary (GHS)','SSNIT No.','TIN','Start Date','Status'];
    const ecoStaff = data.staff.filter(s=>s.entity==='ecopower');
    const rows = ecoStaff.map((s,i)=>[i+1,s.name,s.role||'',s.branch||'',s.phone||'',s.bank||'',s.accountNo||'',Number(s.salary),s.ssnit||'',s.tin||'',s.startDate||'',s.status||'active']);
    if (rows.length > 0) rows.push(['','','','','','','TOTAL MONTHLY',`=SUM(H2:H${rows.length+1})`,'','','','']);
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:4},{wch:25},{wch:20},{wch:20},{wch:16},{wch:16},{wch:20},{wch:18},{wch:16},{wch:14},{wch:12},{wch:10}];
    XLSX.utils.book_append_sheet(wb, ws, 'Payroll - Eco-Power');
  }

  // ---- CLEANERS (Tetteh Osei) ----
  if (scope === 'all' || scope === 'payroll' || scope === 'cleaning') {
    const headers = ['#','Full Name','Establishment / Client','Location','Contact Number','Bank Name','Account Number','Monthly Pay (GHS)','Start Date','Status'];
    const rows = data.cleaners.map((c,i)=>[i+1,c.name,c.establishment||'',c.location||'',c.phone||'',c.bank||'',c.accountNo||'',Number(c.pay||0),c.startDate||'',c.status||'active']);
    if (rows.length > 0) rows.push(['','','','','','','TOTAL MONTHLY',`=SUM(H2:H${rows.length+1})`,'','']);
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:4},{wch:25},{wch:28},{wch:18},{wch:16},{wch:16},{wch:20},{wch:18},{wch:12},{wch:10}];
    XLSX.utils.book_append_sheet(wb, ws, 'Cleaners - Tetteh Osei');
  }

  // ---- CONTRACTS ----
  if (scope === 'all' || scope === 'cleaning') {
    const headers = ['Client','Location','No. of Cleaners','Monthly Value (GHS)','Start Date','End Date','Status','Notes'];
    const rows = data.contracts.map(c=>[c.client,c.location||'',Number(c.cleanerCount||0),Number(c.value||0),c.startDate||'',c.endDate||'',c.status||'active',c.notes||'']);
    if (rows.length > 0) rows.push(['','TOTAL',`=SUM(C2:C${rows.length+1})`,`=SUM(D2:D${rows.length+1})`,'','','','']);
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:28},{wch:18},{wch:16},{wch:20},{wch:12},{wch:12},{wch:10},{wch:35}];
    XLSX.utils.book_append_sheet(wb, ws, 'Contracts - Tetteh Osei');
  }

  // ---- ECO-POWER PRODUCTS ----
  if (scope === 'all' || scope === 'ecopower') {
    const headers = ['Product Name','Unit','Stock Qty','Cost/Unit (GHS)','Retail Price (GHS)','Wholesale Price (GHS)','Dealer Price (GHS)','Reorder Level','Stock Status'];
    const rows = data.ecoProducts.map(p=>[p.name,p.unit,Number(p.stock),Number(p.cost||0),Number(p.retailPrice||0),Number(p.wholesalePrice||0),Number(p.dealerPrice||0),Number(p.reorder||0),Number(p.stock)<=Number(p.reorder)?'LOW STOCK':'OK']);
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:28},{wch:10},{wch:12},{wch:16},{wch:18},{wch:20},{wch:18},{wch:14},{wch:12}];
    XLSX.utils.book_append_sheet(wb, ws, 'Eco-Power Inventory');
  }

  // ---- ECO-POWER SALES ----
  if (scope === 'all' || scope === 'ecopower') {
    const headers = ['Date','Customer','Customer Type','Product','Qty','Unit Price (GHS)','Payment Type','Amount Paid (GHS)','Total (GHS)','Balance Owed (GHS)','Credit Due Date','Contact','Notes'];
    const rows = data.ecoSales.map(s=>[s.date,s.customer,s.customerType,s.productName||'',Number(s.qty),Number(s.unitPrice),s.payType,Number(s.amountPaid||0),Number(s.total),Number(s.balance||0),s.dueDate||'',s.contact||'',s.notes||'']);
    if (rows.length > 0) rows.push(['','','','','','','','TOTAL SALES',`=SUM(I2:I${rows.length+1})`,`=SUM(J2:J${rows.length+1})`,'','','']);
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:12},{wch:22},{wch:16},{wch:22},{wch:8},{wch:16},{wch:14},{wch:18},{wch:16},{wch:18},{wch:16},{wch:16},{wch:25}];
    XLSX.utils.book_append_sheet(wb, ws, 'Eco-Power Sales');
  }

  // ---- ASSETS ----
  if (scope === 'all' || scope === 'assets') {
    const headers = ['Asset Name','Category','Entity','Purchase Date','Cost (GHS)','Useful Life (yrs)','Salvage Value (GHS)','Annual Depreciation (GHS)','Net Book Value (GHS)','Description'];
    const rows = data.assets.map(a=>{
      const depYrs = (now - new Date(a.purchaseDate||now)) / (365.25*24*60*60*1000);
      const annDep = (Number(a.cost)-Number(a.salvage||0)) / Number(a.usefulLife||1);
      const net = Math.max(Number(a.cost) - annDep*depYrs, Number(a.salvage||0));
      return [a.name,a.category,entityLabel(a.entity),a.purchaseDate||'',Number(a.cost),Number(a.usefulLife||5),Number(a.salvage||0),Number(annDep.toFixed(2)),Number(net.toFixed(2)),a.description||''];
    });
    if (rows.length > 0) rows.push(['','','','TOTALS',`=SUM(E2:E${rows.length+1})`,'','',`=SUM(H2:H${rows.length+1})`,`=SUM(I2:I${rows.length+1})`,'']);
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:25},{wch:22},{wch:20},{wch:14},{wch:16},{wch:16},{wch:18},{wch:22},{wch:20},{wch:30}];
    XLSX.utils.book_append_sheet(wb, ws, 'Fixed Assets');
  }

  // ---- LIABILITIES ----
  if (scope === 'all' || scope === 'assets') {
    const headers = ['Description','Type','Entity','Creditor','Amount (GHS)','Due Date','Status'];
    const rows = data.liabilities.map(l=>[l.description,l.type||'',entityLabel(l.entity),l.creditor||'',Number(l.amount),l.dueDate||'',new Date(l.dueDate)<now?'OVERDUE':'Outstanding']);
    if (rows.length > 0) rows.push(['','','','TOTAL',`=SUM(E2:E${rows.length+1})`,'','']);
    const ws = makeSheet(headers, rows);
    ws['!cols'] = [{wch:30},{wch:20},{wch:22},{wch:22},{wch:16},{wch:14},{wch:12}];
    XLSX.utils.book_append_sheet(wb, ws, 'Liabilities');
  }

  // ---- SUMMARY SHEET (always included) ----
  if (scope === 'all') {
    const totalInc = data.income.reduce((s,r)=>s+Number(r.amount),0);
    const totalExp = data.expenditure.reduce((s,r)=>s+Number(r.amount),0);
    const totalPayroll = data.staff.reduce((s,r)=>s+Number(r.salary||0),0) + data.cleaners.reduce((s,c)=>s+Number(c.pay||0),0);
    const ecoRev = data.ecoSales.reduce((s,r)=>s+Number(r.total),0);
    const totalAssets = data.assets.length;
    const summaryData = [
      ['MARTINAS COMPANY LIMITED ‚Äî SYSTEM SUMMARY', ''],
      [`Generated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, ''],
      ['', ''],
      ['METRIC', 'VALUE'],
      ['Total Income (All Time, GHS)', totalInc],
      ['Total Expenditure (All Time, GHS)', totalExp],
      ['Net Profit / Loss (GHS)', totalInc - totalExp],
      ['', ''],
      ['Total Staff (Martinas)', data.staff.filter(s=>s.entity==='martinas').length],
      ['Total Staff (Eco-Power)', data.staff.filter(s=>s.entity==='ecopower').length],
      ['Total Cleaners (Tetteh Osei)', data.cleaners.length],
      ['Total Monthly Payroll (GHS)', totalPayroll],
      ['', ''],
      ['Eco-Power Total Sales Revenue (GHS)', ecoRev],
      ['Eco-Power Outstanding Credit (GHS)', data.ecoSales.filter(s=>Number(s.balance||0)>0).reduce((s,r)=>s+Number(r.balance),0)],
      ['Eco-Power Products in Inventory', data.ecoProducts.length],
      ['', ''],
      ['Fixed Assets Recorded', totalAssets],
      ['Liabilities Recorded', data.liabilities.length],
      ['Active Client Contracts (Tetteh Osei)', data.contracts.filter(c=>c.status==='active').length],
    ];
    const ws = XLSX.utils.aoa_to_sheet(summaryData);
    ws['!cols'] = [{wch:40},{wch:20}];
    XLSX.utils.book_append_sheet(wb, ws, 'Summary');
  }

  // ---- Download ----
  const scopeNames = { all:'Full_Workbook', finance:'Finance', payroll:'Payroll', ecopower:'EcoPower', assets:'Assets_Liabilities', cleaning:'Tetteh_Osei_Cleaning' };
  const filename = `Martinas_EAS_${scopeNames[scope]||scope}_${dateStr}.xlsx`;
  XLSX.writeFile(wb, filename);
  addAudit('Excel Export', 'System', `Exported: ${scopeNames[scope]} ‚Äî ${filename}`);
  notify(`‚úÖ Excel file downloaded: ${filename}`, 'success');
}

// ============================================================
// JSON FULL BACKUP ‚Äî Export
// ============================================================
function exportBackup() {
  const data = db();
  const backup = {
    _meta: {
      version: 'martinas_eas_v2',
      exported: new Date().toISOString(),
      exportedBy: currentUser ? currentUser.name : 'System',
      recordCounts: {
        income: data.income.length,
        expenditure: data.expenditure.length,
        staff: data.staff.length,
        cleaners: data.cleaners.length,
        ecoSales: data.ecoSales.length,
        assets: data.assets.length,
        liabilities: data.liabilities.length,
        docs: data.docs.length,
      }
    },
    ...data
  };

  const json = JSON.stringify(backup, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const dateStr = new Date().toLocaleDateString('en-GH').replace(/\//g,'-');
  a.href = url;
  a.download = `Martinas_EAS_Backup_${dateStr}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  addAudit('Full Backup', 'System', `Complete backup downloaded by ${currentUser?.name}`);
  const info = document.getElementById('lastBackupInfo');
  if (info) info.innerHTML = `<span style="color:var(--success);">‚úÖ Last backup: ${new Date().toLocaleString()}</span>`;
  notify('Full backup downloaded!', 'success');
}

// ============================================================
// JSON FULL BACKUP ‚Äî Import / Restore
// ============================================================
function importBackup(input) {
  const file = input.files[0];
  if (!file) return;
  const statusEl = document.getElementById('importStatus');

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);

      // Basic validation
      if (!backup.users || !backup.income || !backup.expenditure) {
        statusEl.innerHTML = '<span style="color:var(--danger);">‚ùå Invalid backup file. Please select a valid Martinas EAS backup.</span>';
        return;
      }

      const counts = backup._meta?.recordCounts || {};
      const confirmed = confirm(
        `Restore this backup?\n\n` +
        `Exported: ${backup._meta?.exported ? new Date(backup._meta.exported).toLocaleString() : 'Unknown'}\n` +
        `By: ${backup._meta?.exportedBy || 'Unknown'}\n\n` +
        `This will REPLACE all current data:\n` +
        `‚Ä¢ Income: ${backup.income?.length || 0} records\n` +
        `‚Ä¢ Expenditure: ${backup.expenditure?.length || 0} records\n` +
        `‚Ä¢ Staff: ${backup.staff?.length || 0} members\n` +
        `‚Ä¢ Cleaners: ${backup.cleaners?.length || 0} members\n` +
        `‚Ä¢ Eco-Power Sales: ${backup.ecoSales?.length || 0} records\n\n` +
        `Continue?`
      );

      if (!confirmed) { statusEl.innerHTML = '<span style="color:var(--text-muted);">Restore cancelled.</span>'; return; }

      // Remove meta before saving
      const { _meta, ...cleanData } = backup;
      dbSave(cleanData);

      statusEl.innerHTML = '<span style="color:var(--success);">‚úÖ Backup restored successfully! Reloading system...</span>';
      addAudit('Backup Restored', 'System', `Data restored from backup exported ${_meta?.exported||'unknown date'}`);

      setTimeout(() => {
        refreshDashboard();
        renderBackup();
        notify('Backup restored successfully!', 'success');
      }, 1200);

    } catch(err) {
      statusEl.innerHTML = `<span style="color:var(--danger);">‚ùå Failed to read file: ${err.message}</span>`;
    }
  };
  reader.readAsText(file);
  input.value = '';
}

// ============================================================
// IMPORT FROM EXCEL
// ============================================================
function importFromExcel() {
  const file = document.getElementById('excelImportFile').files[0];
  const type = document.getElementById('excelImportType').value;
  const statusEl = document.getElementById('excelImportStatus');

  if (!file) { statusEl.innerHTML = '<span style="color:var(--danger);">‚ùå Please select an Excel file.</span>'; return; }

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

      if (!rows.length) { statusEl.innerHTML = '<span style="color:var(--warning);">‚ö†Ô∏è No data rows found in file.</span>'; return; }

      const data = db();
      let imported = 0;
      let skipped = 0;

      if (type === 'income') {
        rows.forEach(r => {
          if (!r['Date'] || !r['Amount (GHS)']) { skipped++; return; }
          data.income.push({
            id: uid(), entity: Object.keys({martinas:'Martinas',tetteh:'Tetteh Osei',ecopower:'Eco-Power'}).find(k=>entityLabel(k)===r['Entity'])||'martinas',
            date: r['Date']?.toString().slice(0,10)||today(), category: r['Category']||'Other Income',
            amount: Number(r['Amount (GHS)'])||0, description: r['Description']||'', reference: r['Reference']||'',
            from: r['Received From']||'', createdBy: currentUser.name + ' (imported)', createdAt: new Date().toISOString()
          });
          imported++;
        });
      } else if (type === 'expenditure') {
        rows.forEach(r => {
          if (!r['Date'] || !r['Amount (GHS)']) { skipped++; return; }
          data.expenditure.push({
            id: uid(), entity: Object.keys({martinas:'Martinas',tetteh:'Tetteh Osei',ecopower:'Eco-Power'}).find(k=>entityLabel(k)===r['Entity'])||'martinas',
            date: r['Date']?.toString().slice(0,10)||today(), category: r['Category']||'Other',
            amount: Number(r['Amount (GHS)'])||0, description: r['Description']||'', vendor: r['Vendor']||'',
            method: r['Payment Method']||'Cash', createdBy: currentUser.name + ' (imported)', createdAt: new Date().toISOString()
          });
          imported++;
        });
      } else if (type === 'staff') {
        rows.forEach(r => {
          if (!r['Full Name'] || !r['Gross Salary (GHS)']) { skipped++; return; }
          data.staff.push({
            id: uid(), entity: Object.keys({martinas:'Martinas',tetteh:'Tetteh Osei',ecopower:'Eco-Power'}).find(k=>entityLabel(k)===r['Entity'])||'martinas',
            name: r['Full Name']||'', role: r['Role']||'', branch: r['Branch / Location']||'',
            phone: r['Contact Number']||'', bank: r['Bank Name']||'', accountNo: r['Account Number']?.toString()||'',
            salary: Number(r['Gross Salary (GHS)'])||0, startDate: r['Start Date']?.toString().slice(0,10)||'',
            ssnit: r['SSNIT No.']||'', tin: r['TIN']||'', status: r['Status']||'active',
            createdBy: currentUser.name + ' (imported)', createdAt: new Date().toISOString()
          });
          imported++;
        });
      } else if (type === 'cleaners') {
        rows.forEach(r => {
          if (!r['Full Name']) { skipped++; return; }
          data.cleaners.push({
            id: uid(), name: r['Full Name']||'', establishment: r['Establishment / Client']||'',
            location: r['Location']||'', phone: r['Contact Number']||'', bank: r['Bank Name']||'',
            accountNo: r['Account Number']?.toString()||'', pay: Number(r['Monthly Pay (GHS)'])||0,
            startDate: r['Start Date']?.toString().slice(0,10)||'', status: r['Status']||'active',
            createdBy: currentUser.name + ' (imported)'
          });
          imported++;
        });
      } else if (type === 'ecoSales') {
        rows.forEach(r => {
          if (!r['Date'] || !r['Customer']) { skipped++; return; }
          data.ecoSales.push({
            id: uid(), date: r['Date']?.toString().slice(0,10)||today(), customer: r['Customer']||'',
            customerType: r['Customer Type']||'individual', productName: r['Product']||'',
            qty: Number(r['Qty'])||0, unitPrice: Number(r['Unit Price (GHS)'])||0,
            total: Number(r['Total (GHS)'])||0, payType: r['Payment Type']||'cash',
            amountPaid: Number(r['Amount Paid (GHS)'])||0, balance: Number(r['Balance Owed (GHS)'])||0,
            dueDate: r['Credit Due Date']||'', contact: r['Contact']||'', notes: r['Notes']||'',
            createdBy: currentUser.name + ' (imported)'
          });
          imported++;
        });
      }

      dbSave(data);
      addAudit('Excel Import', 'System', `Imported ${imported} ${type} records from Excel`);
      statusEl.innerHTML = `<span style="color:var(--success);">‚úÖ Imported ${imported} record(s) successfully.${skipped>0?' ‚ö†Ô∏è '+skipped+' rows skipped (missing required fields).':''}</span>`;
      document.getElementById('excelImportFile').value = '';
      notify(`${imported} records imported!`, 'success');
      refreshDashboard();
    } catch(err) {
      statusEl.innerHTML = `<span style="color:var(--danger);">‚ùå Error reading file: ${err.message}</span>`;
    }
  };
  reader.readAsArrayBuffer(file);
}

</script>
</body>
</html>
